<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="inspection.css">
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="logo">
                <h1>Public Panel</h1>
            </div>

            <div class="user-profile-sidebar">
                <div class="sidebar-avatar">G</div>
                <div class="sidebar-user-info">
                    <h3>Guest User</h3>
                    <p>Public Access</p>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item" onclick="navigateTo('dashboard.html')">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </li>
                <li class="nav-item active">
                    <i class="fas fa-qrcode"></i>
                    <span>Inspection</span>
                </li>
                <li class="nav-item" onclick="navigateTo('public-contact.html')">
                    <i class="fas fa-envelope"></i>
                    <span>Contact</span>
                </li>
                <li class="nav-item" onclick="navigateTo('index.html')">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back</span>
                </li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div class="date" id="currentDate">Monday, 02 March 2020</div>
                <div class="user-info">
                    <div class="user-avatar">G</div>
                    <div>
                        <div>Guest</div>
                    </div>
                </div>
            </div>
            
            <div class="welcome-section">
                <h1>QR Code Scanner</h1>
                <p>Scan QR codes to retrieve portable radio information</p>
            </div>

            <!-- VIEW TABS -->
            <div class="view-tabs">
                <div class="view-tab active" onclick="switchViewTab('scannerView')">QR Scanner</div>
                <div class="view-tab" onclick="switchViewTab('informationView')">Information</div>
            </div>

            <!-- VIEW 1: QR Scanner -->
            <div class="view-content active" id="scannerView">
                <div class="scanner-container">
                    <div class="scanner-header">
                        <h3>QR Code Scanner</h3>
                        <div class="scanner-controls">
                            <button class="action-btn" id="scan-from-phone-btn">
                                <i class="fas fa-camera"></i> Scan from Phone
                            </button>
                            <button class="action-btn" id="scan-from-file-btn">
                                <i class="fas fa-file-image"></i> Scan from File
                            </button>
                        </div>
                    </div>

                    <!-- Small QR Scanner Box -->
                    <div class="scanner-box">
                        <div id="qr-reader-small"></div>
                        <div class="scanner-guide">
                            <i class="fas fa-arrows-alt-h"></i>
                            <i class="fas fa-arrows-alt-h"></i>
                        </div>
                    </div>

                    <!-- File Scan Section -->
                    <div class="file-scan-section">
                        <h4><i class="fas fa-file-image"></i> Scan from File</h4>
                        <input type="file" id="file-input" accept="image/*" style="display: none;">
                        <p style="margin-top: 10px; color: var(--light-text); font-size: 14px;">
                            Select an image containing QR code to scan
                        </p>
                    </div>
                </div>
            </div>

            <!-- VIEW 2: Information (Updated) -->
            <div class="view-content" id="informationView">
                <div class="category-container">
                    <h3>Equipment Categories</h3>
                    <div class="category-grid">
                        <div class="category-card" onclick="navigateTo('public-portableradio.html')">
                            <div class="category-icon">
                                <i class="fas fa-walkie-talkie"></i>
                            </div>
                            <span class="category-label">Portable Radio</span>
                        </div>
                        <div class="category-card" onclick="navigateTo('public-fireppe.html')">
                            <div class="category-icon">
                                <i class="fas fa-helmet-safety"></i>
                            </div>
                            <span class="category-label">Fire PPE</span>
                        </div>
                        <div class="category-card" onclick="navigateTo('public-vehicle.html')">
                            <div class="category-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <span class="category-label">Vehicle</span>
                        </div>
                        <div class="category-card" onclick="navigateTo('public-rescue.html')">
                            <div class="category-icon">
                                <i class="fas fa-life-ring"></i>
                            </div>
                            <span class="category-label">Rescue</span>
                        </div>
                        <div class="category-card" onclick="navigateTo('public-hazmat.html')">
                            <div class="category-icon">
                                <i class="fas fa-biohazard"></i>
                            </div>
                            <span class="category-label">Hazmat</span>
                        </div>
                        <div class="category-card" onclick="navigateTo('public-hose.html')">
                            <div class="category-icon">
                                <i class="fas fa-fire-extinguisher"></i>
                            </div>
                            <span class="category-label">Hose</span>
                        </div>
                        <div class="category-card" onclick="navigateTo('public-scba.html')">
                            <div class="category-icon">
                                <i class="fas fa-lungs"></i>
                            </div>
                            <span class="category-label">SCBA</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase App -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBf9xdF0qmVYaNWFUuEys-P5a1yuTpLdVY",
            authDomain: "project123-82272.firebaseapp.com",
            projectId: "project123-82272",
            storageBucket: "project123-82272.firebasestorage.app",
            messagingSenderId: "97561643123",
            appId: "1:97561643123:web:92596bb20645124f68c206",
            measurementId: "G-D5P85TT95P"
        };

        // Initialize Firebase
        let app, db;
        let html5QrcodeScanner;
        let lastScannedUserId = null;
        let popupTimeout = null;

        // Navigation function
        function navigateTo(page) {
            window.location.href = page;
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
        }

        // Function to switch between view tabs
        function switchViewTab(tabId) {
            // Hide all view contents
            const viewContents = document.querySelectorAll('.view-content');
            viewContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected view content
            document.getElementById(tabId).classList.add('active');
            
            // Update tab active state
            const tabs = document.querySelectorAll('.view-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activate the clicked tab
            event.target.classList.add('active');
        }

        // Function to check for direct access with parameters
        function checkDirectAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const hoseParam = urlParams.get('hose');
            const userParam = urlParams.get('user');
            const scbaParam = urlParams.get('scba');
            const vehicleParam = urlParams.get('vehicle');
            const ambulanceParam = urlParams.get('ambulance');
            const vehicle2Param = urlParams.get('vehicle2');
            const vehicle3Param = urlParams.get('vehicle3');
            const vehicle4Param = urlParams.get('vehicle4');
            
            if (hoseParam) {
                window.location.href = `public-scan-hose.html?hose=${encodeURIComponent(hoseParam)}`;
                return true;
            }
            
            if (userParam) {
                window.location.href = `public-scan.html?user=${encodeURIComponent(userParam)}`;
                return true;
            }
            
            if (scbaParam) {
                window.location.href = `public-scan-scba.html?scba=${encodeURIComponent(scbaParam)}`;
                return true;
            }
            
            if (vehicleParam) {
                window.location.href = `public-scan-vehicle.html?vehicle=${encodeURIComponent(vehicleParam)}`;
                return true;
            }
            
            if (ambulanceParam || vehicle2Param) {
                window.location.href = `public-scan-vehicle2.html?vehicle=${encodeURIComponent(ambulanceParam || vehicle2Param)}`;
                return true;
            }
            
            if (vehicle3Param) {
                window.location.href = `public-scan-vehicle3.html?vehicle=${encodeURIComponent(vehicle3Param)}`;
                return true;
            }
            
            if (vehicle4Param) {
                window.location.href = `public-scan-vehicle4.html?vehicle=${encodeURIComponent(vehicle4Param)}`;
                return true;
            }
            
            return false;
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            console.log("üöÄ Loading public inspection scanner...");
            
            // Check if direct access with parameters
            if (checkDirectAccess()) {
                return; // Stop execution if will redirect
            }
            
            initializeFirebase();
            updateCurrentDate();
            setupFileScan();
            setupScanButtons();
        });

        function initializeFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    console.error("‚ùå Firebase library not loaded");
                    return;
                }
                
                if (!firebase.apps.length) {
                    app = firebase.initializeApp(firebaseConfig);
                } else {
                    app = firebase.app();
                }
                
                db = firebase.firestore();
                console.log("‚úÖ Firebase initialized successfully");
                
            } catch (error) {
                console.error("‚ùå Firebase initialization error:", error);
            }
        }

        // Setup scan buttons
        function setupScanButtons() {
            document.getElementById('scan-from-phone-btn').addEventListener('click', startCameraScan);
            document.getElementById('scan-from-file-btn').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
        }

        // Start scanner function - SMALL SCANNER
        function startCameraScan() {
            // Clear previous scanner
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch(error => {
                    console.error("Failed to clear previous scanner", error);
                });
            }

            // Start new scanner with SMALL size
            html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader-small", 
                { 
                    fps: 10, 
                    qrbox: { 
                        width: 200,   // Small box size
                        height: 200 
                    },
                    aspectRatio: 1.0
                },
                false
            );
            
            html5QrcodeScanner.render(onScanSuccess);
        }

        // Stop scanner function
        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.clear().then(() => {
                    console.log("QR Scanner stopped");
                }).catch(err => {
                    console.error("Failed to stop scanner", err);
                });
            }
        }

        // ====================================================
        // FIXED DETECTION LOGIC FOR MPRV
        // ====================================================

        function detectQRType(decodedText) {
            console.log("üîç Analyzing QR content:", decodedText);
            
            const text = decodedText.trim().toLowerCase();
            
            // Debug function
            function debugDetection(rule, found) {
                console.log(`Rule ${rule}: ${found ? 'MATCHED' : 'NOT MATCHED'}`);
            }
            
            // RULE #1: Check for MPRV by TBE prefix (HIGHEST PRIORITY)
            if (text.includes('tbe')) {
                console.log("‚úÖ DETECTED: MPRV (contains 'TBE')");
                return 'mprv';
            }
            
            // RULE #2: Check for RSV by TBL/TAV/TBH prefix
            if (text.includes('tbl') || text.includes('tav') || text.includes('tbh')) {
                console.log("‚úÖ DETECTED: RSV (contains 'TBL/TAV/TBH')");
                return 'rsv';
            }
            
            // RULE #3: Check specific URLs
            if (text.includes('public-scan-vehicle3.html')) {
                console.log("‚úÖ DETECTED: MPRV (URL contains 'vehicle3')");
                return 'mprv';
            }
            
            if (text.includes('public-scan-vehicle4.html')) {
                console.log("‚úÖ DETECTED: RSV (URL contains 'vehicle4')");
                return 'rsv';
            }
            
            if (text.includes('public-scan-vehicle2.html')) {
                console.log("‚úÖ DETECTED: AMBULANCE (URL contains 'vehicle2')");
                return 'ambulance';
            }
            
            if (text.includes('public-scan-vehicle.html') && 
                !text.includes('vehicle2') && 
                !text.includes('vehicle3') && 
                !text.includes('vehicle4')) {
                console.log("‚úÖ DETECTED: VEHICLE - FIRE TRUCK");
                return 'vehicle';
            }
            
            if (text.includes('public-scan-hose.html')) {
                console.log("‚úÖ DETECTED: HOSE");
                return 'hose';
            }
            
            if (text.includes('public-scan-scba.html')) {
                console.log("‚úÖ DETECTED: SCBA");
                return 'scba';
            }
            
            if (text.includes('public-scan.html')) {
                console.log("‚úÖ DETECTED: RADIO");
                return 'radio';
            }
            
            // RULE #4: Check parameters
            if (text.includes('vehicle3=') || text.includes('mprv=')) {
                console.log("‚úÖ DETECTED: MPRV (parameter 'vehicle3=' or 'mprv=')");
                return 'mprv';
            }
            
            if (text.includes('vehicle4=') || text.includes('rsv=')) {
                console.log("‚úÖ DETECTED: RSV (parameter 'vehicle4=' or 'rsv=')");
                return 'rsv';
            }
            
            if (text.includes('vehicle=')) {
                // Extract vehicle value
                const match = decodedText.match(/vehicle=([^&]+)/i);
                if (match && match[1]) {
                    const vehicleValue = match[1].toUpperCase();
                    console.log("üîç Extracted vehicle value:", vehicleValue);
                    
                    if (vehicleValue.includes('TBE')) {
                        console.log("‚úÖ DETECTED: MPRV (vehicle value contains 'TBE')");
                        return 'mprv';
                    }
                    
                    if (vehicleValue.includes('TBL') || vehicleValue.includes('TAV') || vehicleValue.includes('TBH')) {
                        console.log("‚úÖ DETECTED: RSV (vehicle value contains 'TBL/TAV/TBH')");
                        return 'rsv';
                    }
                    
                    console.log("‚úÖ DETECTED: VEHICLE - FIRE TRUCK (default)");
                    return 'vehicle';
                }
            }
            
            if (text.includes('hose=')) {
                console.log("‚úÖ DETECTED: HOSE (parameter 'hose=')");
                return 'hose';
            }
            
            if (text.includes('scba=')) {
                console.log("‚úÖ DETECTED: SCBA (parameter 'scba=')");
                return 'scba';
            }
            
            if (text.includes('user=')) {
                console.log("‚úÖ DETECTED: RADIO (parameter 'user=')");
                return 'radio';
            }
            
            // RULE #5: Plain text detection
            if (!text.includes('://') && !text.includes('/') && !text.includes('?')) {
                const cleanText = text.toUpperCase();
                
                if (cleanText.includes('TBE')) {
                    console.log("‚úÖ DETECTED: MPRV (plain text with 'TBE')");
                    return 'mprv';
                }
                
                if (cleanText.includes('TBL') || cleanText.includes('TAV') || cleanText.includes('TBH')) {
                    console.log("‚úÖ DETECTED: RSV (plain text with 'TBL/TAV/TBH')");
                    return 'rsv';
                }
                
                console.log("‚úÖ DETECTED: RADIO (plain text)");
                return 'radio';
            }
            
            // LAST RESORT: Default to RADIO
            console.log("‚ö†Ô∏è  UNKNOWN TYPE, defaulting to RADIO");
            return 'radio';
        }                                       

        // Function untuk extract parameter dengan SELAMAT
        function extractParameterSafely(text, paramName) {
            try {
                // Handle full URL
                if (text.includes('://')) {
                    const url = new URL(text);
                    return url.searchParams.get(paramName);
                }
                
                // Handle parameter string
                if (text.includes(paramName + '=')) {
                    const paramPart = text.includes('?') ? text.split('?')[1] : text;
                    const params = new URLSearchParams(paramPart);
                    return params.get(paramName);
                }
                
                return null;
            } catch (e) {
                console.error("Error extracting parameter:", e);
                return null;
            }
        }

        // Debug function untuk lihat apa yang di-scan
        function debugQRScan(decodedText) {
            console.log("=== DEBUG QR SCAN ===");
            console.log("Full text:", decodedText);
            console.log("Lowercase:", decodedText.toLowerCase());
            console.log("Includes 'vehicle3':", decodedText.toLowerCase().includes('vehicle3'));
            console.log("Includes 'tbe':", decodedText.toLowerCase().includes('tbe'));
            console.log("Includes 'public-scan-vehicle3':", decodedText.toLowerCase().includes('public-scan-vehicle3'));
            
            // Check parameters
            if (decodedText.includes('vehicle=')) {
                const match = decodedText.match(/vehicle=([^&]+)/i);
                console.log("Vehicle parameter found:", match ? match[1] : 'No match');
            }
            
            console.log("=== END DEBUG ===");
        }

        // On scan success - FIXED LOGIC
        function onScanSuccess(decodedText, decodedResult) {
            console.log("üì± QR Scanned Successfully");
            debugQRScan(decodedText);
            
            // 1. DETECT JENIS QR DENGAN TEPAT
            const qrType = detectQRType(decodedText);
            console.log("QR Type detected:", qrType);
            
            // 2. STOP SCANNER
            stopScanner();
            
            // 3. PROCESS BERDASARKAN JENIS
            if (qrType === 'hose') {
                processHoseQR(decodedText);
            } else if (qrType === 'scba') {
                processScbaQR(decodedText);
            } else if (qrType === 'vehicle') {
                processVehicleQR(decodedText);
            } else if (qrType === 'ambulance') {
                processAmbulanceQR(decodedText);
            } else if (qrType === 'mprv') {
                processMprvQR(decodedText);
            } else if (qrType === 'rsv') {
                processRsvQR(decodedText);
            } else {
                processRadioQR(decodedText);
            }
        }

        // Function khusus untuk process HOSE QR
        function processHoseQR(decodedText) {
            console.log("üöí Processing HOSE QR code");
            
            let hoseValue = extractParameterSafely(decodedText, 'hose');
            
            if (!hoseValue && decodedText.includes('hose=')) {
                const match = decodedText.match(/hose=([^&]+)/i);
                if (match && match[1]) {
                    hoseValue = decodeURIComponent(match[1]);
                }
            }
            
            if (!hoseValue) {
                hoseValue = decodedText.trim();
                if (hoseValue.toLowerCase().startsWith('hose=')) {
                    hoseValue = hoseValue.substring(5);
                }
            }
            
            if (hoseValue && hoseValue.trim().length > 0) {
                console.log("‚úÖ Redirecting to HOSE page with value:", hoseValue);
                window.location.href = `public-scan-hose.html?hose=${encodeURIComponent(hoseValue.trim())}`;
            } else {
                console.error("‚ùå Invalid hose QR: No hose value found");
                alert("Invalid hose QR code format. Please scan a valid hose QR code.");
                startCameraScan();
            }
        }

        // Function khusus untuk process SCBA QR
        function processScbaQR(decodedText) {
            console.log("üéí Processing SCBA QR code");
            
            let scbaValue = extractParameterSafely(decodedText, 'scba');
            
            if (!scbaValue && decodedText.includes('scba=')) {
                const match = decodedText.match(/scba=([^&]+)/i);
                if (match && match[1]) {
                    scbaValue = decodeURIComponent(match[1]);
                }
            }
            
            if (!scbaValue) {
                scbaValue = decodedText.trim();
                if (scbaValue.toLowerCase().startsWith('scba=')) {
                    scbaValue = scbaValue.substring(5);
                }
            }
            
            if (scbaValue && scbaValue.trim().length > 0) {
                console.log("‚úÖ Redirecting to SCBA page with value:", scbaValue);
                window.location.href = `public-scan-scba.html?scba=${encodeURIComponent(scbaValue.trim())}`;
            } else {
                console.error("‚ùå Invalid SCBA QR: No SCBA value found");
                alert("Invalid SCBA QR code format. Please scan a valid SCBA QR code.");
                startCameraScan();
            }
        }

        // Function khusus untuk process VEHICLE QR (FIRE TRUCK)
        function processVehicleQR(decodedText) {
            console.log("üöö Processing VEHICLE QR code (FIRE TRUCK)");
            
            let vehicleValue = extractParameterSafely(decodedText, 'vehicle');
            
            if (!vehicleValue && decodedText.includes('vehicle=')) {
                const match = decodedText.match(/vehicle=([^&]+)/i);
                if (match && match[1]) {
                    vehicleValue = decodeURIComponent(match[1]);
                }
            }
            
            if (!vehicleValue) {
                vehicleValue = decodedText.trim();
                if (vehicleValue.toLowerCase().startsWith('vehicle=')) {
                    vehicleValue = vehicleValue.substring(8);
                }
            }
            
            if (vehicleValue && vehicleValue.trim().length > 0) {
                console.log("‚úÖ Redirecting to FIRE TRUCK page with value:", vehicleValue);
                window.location.href = `public-scan-vehicle.html?vehicle=${encodeURIComponent(vehicleValue.trim())}`;
            } else {
                console.error("‚ùå Invalid VEHICLE QR: No vehicle value found");
                alert("Invalid VEHICLE QR code format. Please scan a valid VEHICLE QR code.");
                startCameraScan();
            }
        }

        // Function khusus untuk process AMBULANCE QR
        function processAmbulanceQR(decodedText) {
            console.log("üöë Processing AMBULANCE QR code");
            
            let ambulanceValue = extractParameterSafely(decodedText, 'ambulance') || 
                               extractParameterSafely(decodedText, 'vehicle');
            
            if (!ambulanceValue && (decodedText.includes('ambulance=') || decodedText.includes('vehicle='))) {
                let match;
                if (decodedText.includes('ambulance=')) {
                    match = decodedText.match(/ambulance=([^&]+)/i);
                } else if (decodedText.includes('vehicle=')) {
                    match = decodedText.match(/vehicle=([^&]+)/i);
                }
                if (match && match[1]) {
                    ambulanceValue = decodeURIComponent(match[1]);
                }
            }
            
            if (!ambulanceValue) {
                ambulanceValue = decodedText.trim();
                if (ambulanceValue.toLowerCase().startsWith('ambulance=')) {
                    ambulanceValue = ambulanceValue.substring(10);
                } else if (ambulanceValue.toLowerCase().startsWith('vehicle=')) {
                    ambulanceValue = ambulanceValue.substring(8);
                }
            }
            
            if (ambulanceValue && ambulanceValue.trim().length > 0) {
                console.log("‚úÖ Redirecting to AMBULANCE page with value:", ambulanceValue);
                window.location.href = `public-scan-vehicle2.html?vehicle=${encodeURIComponent(ambulanceValue.trim())}`;
            } else {
                console.error("‚ùå Invalid AMBULANCE QR: No ambulance value found");
                alert("Invalid AMBULANCE QR code format. Please scan a valid AMBULANCE QR code.");
                startCameraScan();
            }
        }

        // ====================================================
        // FIXED MPRV QR PROCESSING FUNCTION
        // ====================================================
        function processMprvQR(decodedText) {
            console.log("üöê Processing MPRV QR code - FIXED VERSION");
            
            let vehicleValue = null;
            
            // Priority 1: Extract from vehicle parameter
            vehicleValue = extractParameterSafely(decodedText, 'vehicle');
            
            // Priority 2: Extract from vehicle3 parameter
            if (!vehicleValue) {
                vehicleValue = extractParameterSafely(decodedText, 'vehicle3');
            }
            
            // Priority 3: Extract from mprv parameter
            if (!vehicleValue) {
                vehicleValue = extractParameterSafely(decodedText, 'mprv');
            }
            
            // Priority 4: Manual extraction
            if (!vehicleValue) {
                if (decodedText.includes('vehicle=')) {
                    const match = decodedText.match(/vehicle=([^&]+)/i);
                    if (match && match[1]) {
                        vehicleValue = decodeURIComponent(match[1]);
                    }
                } else if (decodedText.includes('vehicle3=')) {
                    const match = decodedText.match(/vehicle3=([^&]+)/i);
                    if (match && match[1]) {
                        vehicleValue = decodeURIComponent(match[1]);
                    }
                } else if (decodedText.includes('mprv=')) {
                    const match = decodedText.match(/mprv=([^&]+)/i);
                    if (match && match[1]) {
                        vehicleValue = decodeURIComponent(match[1]);
                    }
                }
            }
            
            // Priority 5: Use whole text (clean it)
            if (!vehicleValue) {
                vehicleValue = decodedText.trim();
                // Remove common prefixes
                vehicleValue = vehicleValue
                    .replace(/vehicle=/gi, '')
                    .replace(/vehicle3=/gi, '')
                    .replace(/mprv=/gi, '')
                    .replace(/.*public-scan-vehicle3\.html\??/gi, '')
                    .trim();
                
                // Remove any remaining URL parts
                if (vehicleValue.includes('?')) {
                    vehicleValue = vehicleValue.split('?')[0];
                }
            }
            
            if (vehicleValue && vehicleValue.trim().length > 0) {
                console.log("‚úÖ Redirecting to MPRV page with vehicle:", vehicleValue);
                // REDIRECT KE VEHICLE3.HTML UNTUK MPRV
                window.location.href = `public-scan-vehicle3.html?vehicle=${encodeURIComponent(vehicleValue.trim())}`;
            } else {
                console.error("‚ùå Invalid MPRV QR: No value found");
                alert("Invalid MPRV QR code. Please scan a valid MPRV QR code.");
                startCameraScan();
            }
        }

        // ====================================================
        // FIXED RSV QR PROCESSING FUNCTION
        // ====================================================
        function processRsvQR(decodedText) {
            console.log("üöô Processing RSV QR code - FIXED VERSION");
            
            let vehicleValue = null;
            
            // Priority 1: Extract from vehicle parameter
            vehicleValue = extractParameterSafely(decodedText, 'vehicle');
            
            // Priority 2: Extract from vehicle4 parameter
            if (!vehicleValue) {
                vehicleValue = extractParameterSafely(decodedText, 'vehicle4');
            }
            
            // Priority 3: Extract from rsv parameter
            if (!vehicleValue) {
                vehicleValue = extractParameterSafely(decodedText, 'rsv');
            }
            
            // Priority 4: Manual extraction
            if (!vehicleValue) {
                if (decodedText.includes('vehicle=')) {
                    const match = decodedText.match(/vehicle=([^&]+)/i);
                    if (match && match[1]) {
                        vehicleValue = decodeURIComponent(match[1]);
                    }
                } else if (decodedText.includes('vehicle4=')) {
                    const match = decodedText.match(/vehicle4=([^&]+)/i);
                    if (match && match[1]) {
                        vehicleValue = decodeURIComponent(match[1]);
                    }
                } else if (decodedText.includes('rsv=')) {
                    const match = decodedText.match(/rsv=([^&]+)/i);
                    if (match && match[1]) {
                        vehicleValue = decodeURIComponent(match[1]);
                    }
                }
            }
            
            // Priority 5: Use whole text (clean it)
            if (!vehicleValue) {
                vehicleValue = decodedText.trim();
                // Remove common prefixes
                vehicleValue = vehicleValue
                    .replace(/vehicle=/gi, '')
                    .replace(/vehicle4=/gi, '')
                    .replace(/rsv=/gi, '')
                    .replace(/.*public-scan-vehicle4\.html\??/gi, '')
                    .trim();
                
                // Remove any remaining URL parts
                if (vehicleValue.includes('?')) {
                    vehicleValue = vehicleValue.split('?')[0];
                }
            }
            
            if (vehicleValue && vehicleValue.trim().length > 0) {
                console.log("‚úÖ Redirecting to RSV page with vehicle:", vehicleValue);
                // REDIRECT KE VEHICLE4.HTML UNTUK RSV
                window.location.href = `public-scan-vehicle4.html?vehicle=${encodeURIComponent(vehicleValue.trim())}`;
            } else {
                console.error("‚ùå Invalid RSV QR: No value found");
                alert("Invalid RSV QR code. Please scan a valid RSV QR code.");
                startCameraScan();
            }
        }

        // Function khusus untuk process RADIO QR
        function processRadioQR(decodedText) {
            console.log("üìª Processing RADIO QR code");
            
            let userId = extractParameterSafely(decodedText, 'user');
            
            if (!userId) {
                userId = decodedText.trim();
                console.log("üìª Using plain text as user ID:", userId);
            }
            
            if (userId && userId.trim().length > 0) {
                console.log("‚úÖ Redirecting to RADIO page with ID:", userId);
                window.location.href = `public-scan.html?user=${encodeURIComponent(userId.trim())}`;
            } else {
                console.error("‚ùå Invalid radio QR: No user ID found");
                alert("Invalid radio QR code format. Please scan a valid radio QR code.");
                startCameraScan();
            }
        }

        // Setup file scan - IMPROVED VERSION
        function setupFileScan() {
            const fileInput = document.getElementById('file-input');
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const qrReaderDiv = document.getElementById('qr-reader-small');
                    if (qrReaderDiv) {
                        qrReaderDiv.innerHTML = '';
                    }
                    
                    scanQRFromFileImproved(file);
                }
            });
        }

        // IMPROVED: Scan QR from image file with better error handling
        function scanQRFromFileImproved(file) {
            console.log("üìÅ Scanning file:", file.name);
            
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type.toLowerCase())) {
                alert("Invalid file type. Please select an image file (JPG, PNG, GIF).\n\nDetected type: " + file.type);
                document.getElementById('file-input').value = '';
                return;
            }
            
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                alert("File too large. Please select an image smaller than 10MB.\n\nCurrent size: " + 
                      (file.size / (1024*1024)).toFixed(2) + "MB");
                document.getElementById('file-input').value = '';
                return;
            }
            
            const qrReaderDiv = document.getElementById('qr-reader-small');
            if (qrReaderDiv) {
                qrReaderDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--light-text);">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Processing image file...</p>
                    </div>
                `;
            }
            
            const html5QrCode = new Html5Qrcode("qr-reader-small");
            
            const config = {
                fps: 30,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0,
                disableFlip: false
            };
            
            let attempts = 0;
            const maxAttempts = 3;
            
            function attemptScan() {
                attempts++;
                console.log(`Attempt ${attempts} of ${maxAttempts}...`);
                
                html5QrCode.scanFile(file, true)
                    .then(decodedText => {
                        console.log("‚úÖ File scan successful on attempt", attempts);
                        console.log("üìÑ Decoded text:", decodedText);
                        
                        if (qrReaderDiv) {
                            qrReaderDiv.innerHTML = `
                                <div style="text-align: center; padding: 20px; color: green;">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                    <p>QR Code detected successfully!</p>
                                    <p style="font-size: 12px; word-break: break-all;">${decodedText.substring(0, 50)}...</p>
                                </div>
                            `;
                        }
                        
                        const qrType = detectQRType(decodedText);
                        console.log("üéØ Detected QR type:", qrType);
                        
                        setTimeout(() => {
                            if (qrType === 'hose') {
                                processHoseQR(decodedText);
                            } else if (qrType === 'scba') {
                                processScbaQR(decodedText);
                            } else if (qrType === 'vehicle') {
                                processVehicleQR(decodedText);
                            } else if (qrType === 'ambulance') {
                                processAmbulanceQR(decodedText);
                            } else if (qrType === 'mprv') {
                                processMprvQR(decodedText);
                            } else if (qrType === 'rsv') {
                                processRsvQR(decodedText);
                            } else {
                                console.log("‚ö†Ô∏è  Defaulting to RADIO processing");
                                processRadioQR(decodedText);
                            }
                        }, 500);
                        
                    })
                    .catch(err => {
                        console.error(`‚ùå File scan error on attempt ${attempts}:`, err);
                        
                        if (attempts < maxAttempts) {
                            setTimeout(attemptScan, 300);
                        } else {
                            if (qrReaderDiv) {
                                qrReaderDiv.innerHTML = `
                                    <div style="text-align: center; padding: 20px; color: red;">
                                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                                        <p>Failed to scan QR code</p>
                                        <p style="font-size: 12px;">${err.message || 'Unknown error'}</p>
                                    </div>
                                `;
                            }
                            
                            let errorMsg = "Scan Decline: Failed to scan QR code from file.";
                            if (err.name === 'NotFoundException') {
                                errorMsg = "QR Code not found in the image.\n\nPlease ensure:\n‚Ä¢ QR code is clear and centered\n‚Ä¢ Image is not blurry\n‚Ä¢ Good lighting conditions";
                            } else if (err.name === 'ChecksumException') {
                                errorMsg = "QR Code is damaged or incomplete.\n\nPlease try with:\n‚Ä¢ A clearer image\n‚Ä¢ Higher resolution\n‚Ä¢ Less compression";
                            }
                            
                            alert(errorMsg);
                            document.getElementById('file-input').value = '';
                        }
                    });
            }
            
            attemptScan();
        }
    </script>

    <style>
        /* Category Grid Styles */
        .category-container {
            padding: 20px;
        }

        .category-container h3 {
            margin-bottom: 20px;
            color: var(--dark-text);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .category-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 10px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .category-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .category-icon i {
            font-size: 30px;
            color: white;
        }

        .category-label {
            font-weight: 500;
            text-align: center;
            color: var(--dark-text);
        }

        /* Scale down QR image preview */
        #qr-reader-small img {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
        }
        
        /* Loading animation */
        .fa-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>