<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fire PPE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #c9302c;
            --secondary-color: #6a7c92;
            --light-bg: #f8f9fa;
            --dark-bg: #1a202c;
            --dark-text: #2d3748;
            --light-text: #718096;
            --border-color: #e2e8f0;
        }

        [data-theme="dark"] {
            --light-bg: #1a202c;
            --dark-text: #e2e8f0;
            --light-text: #a0aec0;
            --border-color: #2d3748;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
            transition: all 0.3s ease;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .sidebar {
            background-color: #2d3748;
        }
        
        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .logo h1 {
            color: var(--primary-color);
            font-size: 24px;
        }
        
        .user-profile-sidebar {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sidebar-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), #c9302c);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .sidebar-user-info h3 {
            font-size: 16px;
            margin-bottom: 4px;
            color: var(--dark-text);
        }
        
        .sidebar-user-info p {
            font-size: 12px;
            color: var(--light-text);
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            padding: 12px 20px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            border-radius: 0 8px 8px 0;
        }
        
        .nav-item.active {
            background-color: rgba(74, 108, 247, 0.1);
            border-left: 4px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .nav-item:hover:not(.active) {
            background-color: rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .nav-item:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .nav-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            margin-left: 250px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .main-content {
            background-color: #1a202c;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .date {
            color: var(--light-text);
            font-size: 14px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .welcome-section {
            margin-bottom: 30px;
        }
        
        .welcome-section h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .welcome-section p {
            color: var(--light-text);
        }

        /* ADMIN FORM STYLES */
        .form-container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        [data-theme="dark"] .form-container {
            background: #2d3748;
        }

        .form-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .form-header h3 {
            color: var(--dark-text);
            margin: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-column {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-text);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--light-bg);
            color: var(--dark-text);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] input, 
        [data-theme="dark"] select, 
        [data-theme="dark"] textarea {
            background-color: #1a202c;
            border-color: #4a5568;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #3a5bf0;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6c80;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        /* TABLE STYLES */
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
            margin-bottom: 30px;
        }

        [data-theme="dark"] .table-container {
            background: #2d3748;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-header h3 {
            color: var(--dark-text);
            margin: 0;
        }

        .table-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding-left: 40px;
            width: 250px;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-text);
        }

        .refresh-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #c9302c;
            

        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: rgba(74, 108, 247, 0.05);
            font-weight: 600;
            color: var(--dark-text);
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background-color: rgba(74, 108, 247, 0.1);
        }

        th i {
            margin-left: 5px;
            opacity: 0.5;
        }

        th.sort-asc i, th.sort-desc i {
            opacity: 1;
        }

        [data-theme="dark"] th {
            background-color: rgba(74, 108, 247, 0.1);
        }

        tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #4299e1;
            color: white;
        }

        .btn-edit:hover {
            background: #3182ce;
        }

        .btn-delete {
            background: #e53e3e;
            color: white;
        }

        .btn-delete:hover {
            background: #c53030;
        }

        /* Quantity Status Styles */
        .quantity-low {
            color: #e53e3e;
            font-weight: bold;
        }

        .quantity-adequate {
            color: #38a169;
            font-weight: bold;
        }

        .timestamp-malaysia {
            font-size: 12px;
            color: var(--light-text);
            line-height: 1.3;
        }

        .timestamp-malaysia div:first-child {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .timestamp-malaysia div:last-child {
            font-size: 11px;
            color: var(--light-text);
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--light-text);
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--light-text);
        }

        /* COMPACT Size and Quantity Section Styles */
        .size-quantity-section {
            margin-bottom: 20px;
        }

        .size-quantity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .size-quantity-header h4 {
            color: var(--dark-text);
            margin: 0;
        }

        .size-quantity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .size-item-compact {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .size-label-compact {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }

        .size-label-compact input[type="radio"] {
            width: auto;
            margin: 0;
        }

        .size-qty-input-compact {
            width: 70px !important;
            padding: 6px !important;
            text-align: center;
        }

        .size-action-btn {
            padding: 4px 8px !important;
            font-size: 11px !important;
        }

        .size-display {
            background: var(--light-bg);
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }

        .size-display h5 {
            margin-bottom: 10px;
            color: var(--dark-text);
        }

        .size-display-content {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .size-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        [data-theme="dark"] .size-item {
            background: #1a202c;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar .logo h1, 
            .sidebar .nav-item span,
            .sidebar-user-info {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .user-profile-sidebar {
                justify-content: center;
                padding: 15px 10px;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .table-container {
                padding: 15px;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 8px 10px;
            }

            .table-controls {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .search-box input {
                width: 100%;
            }

            .size-quantity-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        /* Tabs for forms */
        .form-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .form-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .form-tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        .form-tab:hover:not(.active) {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .form-content {
            display: none;
        }

        .form-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="logo">
                <h1>Admin Panel</h1>
            </div>

            <div class="user-profile-sidebar">
                <div class="sidebar-avatar">A</div>
                <div class="sidebar-user-info">
                    <h3>Admin User</h3>
                    <p>Administrator</p>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item" onclick="navigateTo('admin-dashboard.html')">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </li>
                <li class="nav-item active">
                    <i class="fas fa-hard-hat"></i>
                    <span>Fire PPE</span>
                </li>
                <li class="nav-item" onclick="navigateTo('admin-contact.html')">
                    <i class="fas fa-envelope"></i>
                    <span>Contact</span>
                </li>
               <li class="nav-item" onclick="logout()" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
               <i class="fas fa-sign-out-alt"></i>
               <span>Logout</span>
               </li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div class="date" id="currentDate">Monday, 02 March 2020</div>
                <div class="user-info">
                    <div class="user-avatar">A</div>
                    <div>
                        <div>Admin</div>
                    </div>
                </div>
            </div>
            
            <div class="welcome-section">
                <h1>Fire PPE Management</h1>
                <p>Add, edit, and manage Fire PPE Equipment</p>
            </div>

            <!-- FORM TABS -->
            <div class="form-tabs">
                <div class="form-tab active" onclick="switchFormTab('form1', this)">Fire PPE Form</div>
                <div class="form-tab" onclick="switchFormTab('form2', this)">Fire PPE Stock</div>
            </div>

            <!-- FORM 1: PPE Issuance -->
            <div class="form-container form-content active" id="form1">
                <div class="form-header">
                    <h3>Add Fire PPE Form</h3>
                </div>
                <form id="ppeIssuanceForm">
                    <div class="form-row">
                        <div class="form-column">
                            <div class="form-group">
                                <label for="typesOfPPE1">Types of PPE *</label>
                                <select id="typesOfPPE1" name="typesOfPPE" required>
                                    <option value="">Select PPE Type</option>
                                    <option value="Firefighting Helmet (HPS7000)">Firefighting Helmet (HPS7000)</option>
                                    <option value="Head Hood">Head Hood</option>
                                    <option value="Bunker Gear">Bunker Gear</option>
                                    <option value="Firefighting Gloves">Firefighting Gloves</option>
                                    <option value="Firefighting Boots">Firefighting Boots</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group size-quantity-section">
                        <div class="size-quantity-header">
                            <h4>Size and Quantity</h4>
                        </div>
                        
                        <!-- COMPACT SIZE GRID -->
                        <div class="size-quantity-grid" id="sizeQuantityGrid1">
                            <!-- Sizes will be populated here -->
                        </div>
                        
                        <div class="size-display">
                            <h5>Selected Sizes:</h5>
                            <div class="size-display-content" id="sizeDisplay1">
                                <!-- Size items will be displayed here -->
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-column">
                            <div class="form-group">
                                <label for="latestIssuance">Latest Issuance *</label>
                                <input type="text" id="latestIssuance" name="latestIssuance" placeholder="Enter latest issuance details" required>
                            </div>
                        </div>
                        <div class="form-column">
                            <div class="form-group">
                                <label for="issuanceDate">Issuance Date *</label>
                                <input type="date" id="issuanceDate" name="issuanceDate" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-column">
                            <div class="form-group">
                                <label for="remarks1">Remarks</label>
                                <textarea id="remarks1" name="remarks" rows="3" placeholder="Additional notes or condition remarks"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm('ppeIssuanceForm', 'sizeDisplay1')">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </form>
            </div>

            <!-- FORM 2: PPE Stock -->
            <div class="form-container form-content" id="form2">
                <div class="form-header">
                    <h3>Fire PPE Stock</h3>
                </div>
                <form id="ppeStockForm">
                    <div class="form-row">
                        <div class="form-column">
                            <div class="form-group">
                                <label for="typesOfPPE2">Types of PPE *</label>
                                <select id="typesOfPPE2" name="typesOfPPE" required onchange="autoFillPPEMinQty()">
                                    <option value="">Select PPE Type</option>
                                    <option value="Firefighting Helmet (HPS7000)">Firefighting Helmet (HPS7000)</option>
                                    <option value="Head Hood">Head Hood</option>
                                    <option value="Bunker Gear">Bunker Gear</option>
                                    <option value="Firefighting Gloves">Firefighting Gloves</option>
                                    <option value="Firefighting Boots">Firefighting Boots</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-column">
                            <div class="form-group">
                                <label for="minQty">Min. Stock Qty *</label>
                                <input type="number" id="minQty" name="minQty" min="0" placeholder="Enter minimum stock quantity" required>
                            </div>
                        </div>
                        <div class="form-column">
                            <div class="form-group">
                                <label for="currentQty">Current Qty *</label>
                                <input type="number" id="currentQty" name="currentQty" min="0" placeholder="Enter current quantity" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm('ppeStockForm')">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </form>
            </div>

            <!-- TABLE 1: PPE Issuance -->
            <div class="table-container" id="issuanceTable">
                <div class="table-header">
                    <h3>PPE Issuance Records</h3>
                    <div class="table-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchIssuance" placeholder="Search records..." onkeyup="searchTable('issuance')">
                        </div>
                        <button class="refresh-btn" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="loading" id="loadingIssuanceMessage">
                    <i class="fas fa-spinner fa-spin"></i> Loading issuance data from Firebase...
                </div>

                <div class="no-data" id="noIssuanceDataMessage" style="display: none;">
                    <i class="fas fa-inbox"></i> No Fire PPE data available
                </div>

                <div id="issuanceTableContent" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable('issuance', 'typesOfPPE')">Types of PPE <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable('issuance', 'sizes')">Sizes <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable('issuance', 'latestIssuance')">Latest Issuance <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable('issuance', 'issuanceDate')">Issuance Date <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable('issuance', 'remarks')">Remarks <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable('issuance', 'timestamp')">Date Added <i class="fas fa-sort"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ppeIssuanceTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TABLE 2: PPE Stock -->
            <div class="table-container" id="stockTable" style="display: none;">
                <div class="table-header">
                    <h3>PPE Stock Inventory</h3>
                    <div class="table-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchStock" placeholder="Search stock records..." onkeyup="searchTable('stock')">
                        </div>
                        <button class="refresh-btn" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="loading" id="loadingStockMessage">
                    <i class="fas fa-spinner fa-spin"></i> Loading stock data from Firebase...
                </div>

                <div class="no-data" id="noStockDataMessage" style="display: none;">
                    <i class="fas fa-inbox"></i> No stock data available
                </div>

                <div id="stockTableContent" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable('stock', 'typesOfPPE')">Types of PPE <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable('stock', 'minQty')">Min Stock <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable('stock', 'currentQty')">Current Qty <i class="fas fa-sort"></i></th>
                                <th>Status</th>
                                <th onclick="sortTable('stock', 'timestamp')">Date Added <i class="fas fa-sort"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ppeStockTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase App -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Navigation function
        function navigateTo(page) {
            window.location.href = page;
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', options);
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to log out?')) {
                localStorage.removeItem('adminToken');
                window.location.href = 'login.html';
            }
        }

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBf9xdF0qmVYaNWFUuEys-P5a1yuTpLdVY",
            authDomain: "project123-82272.firebaseapp.com",
            projectId: "project123-82272",
            storageBucket: "project123-82272.firebasestorage.app",
            messagingSenderId: "97561643123",
            appId: "1:97561643123:web:92596bb20645124f68c206",
            measurementId: "G-D5P85TT95P"
        };

        // Initialize Firebase
        let app, db;
        let editingId = null;
        let editingType = null; // 'issuance' or 'stock'
        let sizeQuantities = {};

        // Sorting state
        let sortState = {
            issuance: { field: null, direction: 'asc' },
            stock: { field: null, direction: 'asc' }
        };

        // Size options
        const sizeOptions = ['S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL', '6XL'];

        window.addEventListener('load', function() {
            console.log("üöÄ Loading admin fire PPE page...");
            initializeFirebase();
            updateCurrentDate();
            setupFormListeners();
            initializeSizeGrid();
            
            // Set initial table visibility - show issuance table first
            document.getElementById('issuanceTable').style.display = 'block';
            document.getElementById('stockTable').style.display = 'none';
            
            // Add event listener untuk auto-fill min qty when PPE type is selected
            const ppeSelect = document.getElementById('typesOfPPE2');
            if (ppeSelect) {
                ppeSelect.addEventListener('change', autoFillPPEMinQty);
            }
        });

        function initializeFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    console.error("‚ùå Firebase library not loaded");
                    alert("Firebase library failed to load. Please check your internet connection.");
                    return;
                }
                
                if (!firebase.apps.length) {
                    app = firebase.initializeApp(firebaseConfig);
                } else {
                    app = firebase.app();
                }
                
                db = firebase.firestore();
                
                console.log("‚úÖ Firebase initialized successfully for fire PPE page");
                loadFirePPEData();
                
            } catch (error) {
                console.error("‚ùå Firebase initialization error:", error);
                console.log("‚ö†Ô∏è Firebase failed but navigation should still work");
            }
        }

        function setupFormListeners() {
            const issuanceForm = document.getElementById('ppeIssuanceForm');
            const stockForm = document.getElementById('ppeStockForm');
            
            if (issuanceForm) {
                issuanceForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveFirePPEData('issuance');
                });
            }
            
            if (stockForm) {
                stockForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveFirePPEData('stock');
                });
            }
        }

        // FUNCTION YANG DIPERBAIKI: Auto-fill min qty berdasarkan jenis PPE yang dipilih
        function autoFillPPEMinQty() {
            if (!db) {
                console.log("‚ùå Firebase not initialized");
                return;
            }
            
            const selectedPPE = document.getElementById('typesOfPPE2').value;
            
            if (!selectedPPE) {
                console.log("‚ÑπÔ∏è No PPE type selected");
                document.getElementById('minQty').value = '';
                return;
            }
            
            console.log("üîç Getting min qty for selected PPE type:", selectedPPE);
            
            // Cari rekod untuk jenis PPE yang dipilih (yang TERBARU)
            db.collection('firePPEStock')
                .where('typesOfPPE', '==', selectedPPE)
                .orderBy('timestamp', 'desc')
                .limit(1)
                .get()
                .then((snapshot) => {
                    if (!snapshot.empty) {
                        const latestRecord = snapshot.docs[0].data();
                        const latestMinQty = latestRecord.minQty;
                        
                        console.log("‚úÖ FOUND PPE STOCK RECORD - Min Qty:", latestMinQty, "for", selectedPPE);
                        
                        // Auto-set min qty field dengan nilai untuk PPE yang dipilih
                        document.getElementById('minQty').value = latestMinQty;
                        console.log("üéâ AUTO-FILLED Min Qty for", selectedPPE, ":", latestMinQty);
                        
                    } else {
                        console.log("‚ùå No records found for", selectedPPE, "in firePPEStock database");
                        document.getElementById('minQty').value = '';
                    }
                })
                .catch((error) => {
                    console.log("‚ùå Error getting PPE stock record:", error);
                    document.getElementById('minQty').value = '';
                });
        }

        // Initialize compact size grid
        function initializeSizeGrid() {
            const grid = document.getElementById('sizeQuantityGrid1');
            if (!grid) return;

            let html = '';
            sizeOptions.forEach(size => {
                html += `
                    <div class="size-item-compact">
                        <div class="size-label-compact">
                            <input type="radio" name="sizeRadio1" value="${size}">
                            <span>${size}</span>
                        </div>
                        <input type="number" class="size-qty-input-compact" data-size="${size}" min="0" placeholder="0">
                        <button type="button" class="btn-sm btn-primary size-action-btn" onclick="addSizeToDisplay('${size}', 'sizeDisplay1')">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        // Function to switch between form tabs - FIXED VERSION
        function switchFormTab(tabId, clickedTab) {
            // Hide all form contents
            const formContents = document.querySelectorAll('.form-content');
            formContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected form content
            document.getElementById(tabId).classList.add('active');
            
            // Update tab active state
            const tabs = document.querySelectorAll('.form-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activate the clicked tab
            clickedTab.classList.add('active');
            
            // Show/hide tables based on active tab
            if (tabId === 'form1') {
                // Show issuance table, hide stock table
                document.getElementById('issuanceTable').style.display = 'block';
                document.getElementById('stockTable').style.display = 'none';
            } else if (tabId === 'form2') {
                // Show stock table, hide issuance table
                document.getElementById('issuanceTable').style.display = 'none';
                document.getElementById('stockTable').style.display = 'block';
                
                // Auto-fill min qty when switching to stock tab based on selected PPE
                setTimeout(autoFillPPEMinQty, 300);
            }
        }

        // Function to add size to display
        function addSizeToDisplay(size, displayId) {
            const qtyInput = document.querySelector(`.size-qty-input-compact[data-size="${size}"]`);
            const qty = parseInt(qtyInput.value) || 0;
            
            if (qty <= 0) {
                alert("Please enter a valid quantity for size " + size);
                return;
            }
            
            // Add or update the size in the sizeQuantities object
            sizeQuantities[size] = qty;
            
            // Update the display
            updateSizeDisplay(displayId);
            
            // Clear the input field
            qtyInput.value = '';
            
            console.log("‚úÖ Added size:", size, "with quantity:", qty);
        }

        // Function to update the size display
        function updateSizeDisplay(displayId) {
            const sizeDisplay = document.getElementById(displayId);
            sizeDisplay.innerHTML = '';
            
            // Create a sorted array of sizes
            const sizes = Object.keys(sizeQuantities).sort((a, b) => {
                const sizeOrder = ['S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL', '6XL'];
                return sizeOrder.indexOf(a) - sizeOrder.indexOf(b);
            });
            
            // Add each size to the display
            sizes.forEach(size => {
                const sizeItem = document.createElement('div');
                sizeItem.className = 'size-item';
                sizeItem.innerHTML = `${size} - ${sizeQuantities[size]}`;
                
                // Add remove button
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-sm btn-danger';
                removeBtn.style.marginLeft = '8px';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.onclick = function() {
                    removeSize(size, displayId);
                };
                
                sizeItem.appendChild(removeBtn);
                sizeDisplay.appendChild(sizeItem);
            });
        }

        // Function to remove a size from display
        function removeSize(size, displayId) {
            delete sizeQuantities[size];
            updateSizeDisplay(displayId);
        }

        // FUNCTION YANG DIPERBAIKI: Save data dengan pencegahan duplicate untuk jenis PPE yang sama
        async function saveFirePPEData(type) {
            if (!db) {
                alert("Firebase not initialized. Please refresh the page.");
                return;
            }

            let formData = {};
            let collectionName = '';

            if (type === 'issuance') {
                // Validation - check if at least one size is added
                if (Object.keys(sizeQuantities).length === 0) {
                    alert("Please add at least one size with quantity");
                    return;
                }

                // Convert sizeQuantities object to formatted string
                const sizesString = Object.keys(sizeQuantities)
                    .map(size => `${size} - ${sizeQuantities[size]}`)
                    .join(', ');

                formData = {
                    typesOfPPE: document.getElementById('typesOfPPE1').value,
                    sizes: sizesString,
                    latestIssuance: document.getElementById('latestIssuance').value,
                    issuanceDate: document.getElementById('issuanceDate').value,
                    remarks: document.getElementById('remarks1').value,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                collectionName = 'firePPEIssuance';
            } else if (type === 'stock') {
                formData = {
                    typesOfPPE: document.getElementById('typesOfPPE2').value,
                    minQty: parseInt(document.getElementById('minQty').value),
                    currentQty: parseInt(document.getElementById('currentQty').value),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() // Update timestamp setiap kali
                };

                collectionName = 'firePPEStock';
            }

            console.log("Data to save:", formData);

            // Validation
            if (type === 'issuance') {
                if (!formData.typesOfPPE || !formData.latestIssuance || !formData.issuanceDate) {
                    alert("Please fill in all required fields");
                    return;
                }
            } else if (type === 'stock') {
                if (!formData.typesOfPPE || formData.minQty < 0 || formData.currentQty < 0) {
                    alert("Please fill in all required fields with valid values");
                    return;
                }
            }

            if (editingId && editingType === type) {
                // Update existing record - update timestamp juga
                formData.timestamp = firebase.firestore.FieldValue.serverTimestamp();
                
                db.collection(collectionName).doc(editingId).update(formData)
                    .then(() => {
                        console.log(`‚úÖ Fire PPE ${type} updated successfully`);
                        alert(`Fire PPE ${type} updated successfully!`);
                        clearForm(type === 'issuance' ? 'ppeIssuanceForm' : 'ppeStockForm', 
                                 type === 'issuance' ? 'sizeDisplay1' : null);
                        loadFirePPEData();
                    })
                    .catch(error => {
                        console.error(`‚ùå Error updating fire PPE ${type}:`, error);
                        alert(`Error updating fire PPE ${type}: ` + error.message);
                    });
            } else {
                // Untuk PPE Stock: Periksa jika jenis PPE sudah wujud
                if (type === 'stock') {
                    try {
                        // Cari jika sudah ada rekod untuk jenis PPE ini
                        const querySnapshot = await db.collection(collectionName)
                            .where('typesOfPPE', '==', formData.typesOfPPE)
                            .limit(1)
                            .get();
                        
                        if (!querySnapshot.empty) {
                            // Jenis PPE sudah wujud, update rekod sedia ada
                            const existingDoc = querySnapshot.docs[0];
                            const docId = existingDoc.id;
                            const existingData = existingDoc.data();
                            
                            // Tanya pengguna samada nak update
                            const confirmUpdate = confirm(
                                `"${formData.typesOfPPE}" already exists in the database.\n\n` +
                                `Current values: Min=${existingData.minQty}, Current=${existingData.currentQty}\n` +
                                `New values: Min=${formData.minQty}, Current=${formData.currentQty}\n\n` +
                                `Do you want to update the existing record?`
                            );
                            
                            if (confirmUpdate) {
                                // Update rekod sedia ada dengan timestamp baru
                                formData.timestamp = firebase.firestore.FieldValue.serverTimestamp();
                                
                                await db.collection(collectionName).doc(docId).update(formData);
                                console.log(`‚úÖ Existing PPE stock record updated successfully`);
                                alert(`PPE stock record for "${formData.typesOfPPE}" updated successfully!`);
                                clearForm('ppeStockForm');
                                loadFirePPEData();
                                return;
                            } else {
                                console.log("‚ùå User cancelled update operation");
                                return;
                            }
                        }
                    } catch (error) {
                        console.error("‚ùå Error checking for duplicate PPE:", error);
                    }
                }
                
                // Jika tidak ada duplicate atau untuk PPE Issuance, tambah rekod baru
                db.collection(collectionName).add(formData)
                    .then(() => {
                        console.log(`‚úÖ Fire PPE ${type} added successfully`);
                        alert(`Fire PPE ${type} added successfully!`);
                        clearForm(type === 'issuance' ? 'ppeIssuanceForm' : 'ppeStockForm', 
                                 type === 'issuance' ? 'sizeDisplay1' : null);
                        loadFirePPEData();
                    })
                    .catch(error => {
                        console.error(`‚ùå Error adding fire PPE ${type}:`, error);
                        alert(`Error adding fire PPE ${type}: ` + error.message);
                    });
            }
        }

        function loadFirePPEData() {
            // Load both data initially, but tables will be shown/hidden based on active tab
            loadIssuanceData();
            loadStockData();
        }

        function loadIssuanceData() {
            const loadingMessage = document.getElementById('loadingIssuanceMessage');
            const noDataMessage = document.getElementById('noIssuanceDataMessage');
            const tableContent = document.getElementById('issuanceTableContent');

            if (!db) {
                console.error("‚ùå Firestore not initialized");
                if (loadingMessage) {
                    loadingMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Firebase not initialized';
                }
                return;
            }

            console.log("üì° Loading fire PPE issuance data...");

            db.collection('firePPEIssuance')
                .orderBy('timestamp', 'desc')
                .get()
                .then((snapshot) => {
                    console.log("üìä Issuance data loaded:", snapshot.size, "documents");
                    if (loadingMessage) loadingMessage.style.display = 'none';
                    
                    if (snapshot.empty) {
                        console.log("‚ÑπÔ∏è No data found in firePPEIssuance collection");
                        if (noDataMessage) noDataMessage.style.display = 'block';
                        if (tableContent) tableContent.style.display = 'none';
                        return;
                    }

                    if (noDataMessage) noDataMessage.style.display = 'none';
                    if (tableContent) tableContent.style.display = 'block';
                    
                    let html = '';
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const id = doc.id;
                        
                        // Format date for display
                        const issuanceDate = data.issuanceDate ? 
                            new Date(data.issuanceDate).toLocaleDateString() : 'N/A';
                        
                        // Format timestamp untuk Malaysia
                        let timestampDisplay = 'N/A';
                        if (data.timestamp) {
                            const timestamp = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
                            const day = timestamp.getDate().toString().padStart(2, '0');
                            const month = (timestamp.getMonth() + 1).toString().padStart(2, '0');
                            const year = timestamp.getFullYear();
                            const hours = timestamp.getHours();
                            const minutes = timestamp.getMinutes().toString().padStart(2, '0');
                            const ampm = hours >= 12 ? 'pm' : 'am';
                            const hours12 = hours % 12 || 12;
                            
                            timestampDisplay = `
                                <div class="timestamp-malaysia">
                                    <div>${day}/${month}/${year}</div>
                                    <div>${hours12}:${minutes} ${ampm}</div>
                                </div>
                            `;
                        }
                        
                        html += `
                            <tr>
                                <td>${data.typesOfPPE || 'N/A'}</td>
                                <td>${data.sizes || 'N/A'}</td>
                                <td>${data.latestIssuance || 'N/A'}</td>
                                <td>${issuanceDate}</td>
                                <td>${data.remarks || 'No remarks'}</td>
                                <td>${timestampDisplay}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-sm btn-edit" onclick="editFirePPE('${id}', 'issuance')">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button class="btn-sm btn-delete" onclick="deleteFirePPE('${id}', 'issuance')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    if (document.getElementById('ppeIssuanceTableBody')) {
                        document.getElementById('ppeIssuanceTableBody').innerHTML = html;
                    }
                    console.log("‚úÖ Issuance table data displayed successfully");
                    
                })
                .catch((error) => {
                    console.error('‚ùå Error loading issuance data:', error);
                    if (loadingMessage) loadingMessage.style.display = 'none';
                    if (noDataMessage) {
                        noDataMessage.style.display = 'block';
                        noDataMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error loading data from Firebase. Please try refreshing.';
                    }
                });
        }

        function loadStockData() {
            const loadingMessage = document.getElementById('loadingStockMessage');
            const noDataMessage = document.getElementById('noStockDataMessage');
            const tableContent = document.getElementById('stockTableContent');

            if (!db) {
                console.error("‚ùå Firestore not initialized");
                if (loadingMessage) {
                    loadingMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Firebase not initialized';
                }
                return;
            }

            console.log("üì° Loading fire PPE stock data...");

            db.collection('firePPEStock')
                .orderBy('timestamp', 'desc')
                .get()
                .then((snapshot) => {
                    console.log("üìä Stock data loaded:", snapshot.size, "documents");
                    if (loadingMessage) loadingMessage.style.display = 'none';
                    
                    if (snapshot.empty) {
                        console.log("‚ÑπÔ∏è No data found in firePPEStock collection");
                        if (noDataMessage) noDataMessage.style.display = 'block';
                        if (tableContent) tableContent.style.display = 'none';
                        return;
                    }

                    if (noDataMessage) noDataMessage.style.display = 'none';
                    if (tableContent) tableContent.style.display = 'block';
                    
                    let html = '';
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const id = doc.id;
                        
                        let minQtyDisplay = data.minQty || '0';
                        let currentQtyDisplay = data.currentQty || '0';
                        let status = '';

                        // Format timestamp untuk Malaysia
                        let timestampDisplay = 'N/A';
                        if (data.timestamp) {
                            const timestamp = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
                            const day = timestamp.getDate().toString().padStart(2, '0');
                            const month = (timestamp.getMonth() + 1).toString().padStart(2, '0');
                            const year = timestamp.getFullYear();
                            const hours = timestamp.getHours();
                            const minutes = timestamp.getMinutes().toString().padStart(2, '0');
                            const ampm = hours >= 12 ? 'pm' : 'am';
                            const hours12 = hours % 12 || 12;
                            
                            timestampDisplay = `
                                <div class="timestamp-malaysia">
                                    <div>${day}/${month}/${year}</div>
                                    <div>${hours12}:${minutes} ${ampm}</div>
                                </div>
                            `;
                        }

                        // Jika current quantity kurang daripada min quantity, current qty turns red
                        // Jika current quantity lebih atau sama dengan min quantity, current qty turns green
                        if (data.currentQty < data.minQty) {
                            currentQtyDisplay = `<span class="quantity-low">${data.currentQty}</span>`;
                            status = '<span class="quantity-low">Low Stock</span>';
                        } else {
                            currentQtyDisplay = `<span class="quantity-adequate">${data.currentQty}</span>`;
                            status = '<span class="quantity-adequate">Adequate</span>';
                        }
                        
                        html += `
                            <tr>
                                <td>${data.typesOfPPE || 'N/A'}</td>
                                <td>${minQtyDisplay}</td>
                                <td>${currentQtyDisplay}</td>
                                <td>${status}</td>
                                <td>${timestampDisplay}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-sm btn-edit" onclick="editFirePPE('${id}', 'stock')">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button class="btn-sm btn-delete" onclick="deleteFirePPE('${id}', 'stock')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    if (document.getElementById('ppeStockTableBody')) {
                        document.getElementById('ppeStockTableBody').innerHTML = html;
                    }
                    console.log("‚úÖ Stock table data displayed successfully");
                    
                })
                .catch((error) => {
                    console.error('‚ùå Error loading stock data:', error);
                    if (loadingMessage) loadingMessage.style.display = 'none';
                    if (noDataMessage) {
                        noDataMessage.style.display = 'block';
                        noDataMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error loading data from Firebase. Please try refreshing.';
                    }
                });
        }

        function editFirePPE(id, type) {
            if (!db) {
                alert("Firebase not initialized. Please refresh the page.");
                return;
            }

            const collectionName = type === 'issuance' ? 'firePPEIssuance' : 'firePPEStock';

            db.collection(collectionName).doc(id).get()
                .then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        
                        if (type === 'issuance') {
                            // Switch to issuance form tab
                            switchFormTab('form1', document.querySelector('.form-tab[onclick*="form1"]'));
                            
                            // Fill form with existing data
                            document.getElementById('typesOfPPE1').value = data.typesOfPPE || '';
                            document.getElementById('latestIssuance').value = data.latestIssuance || '';
                            document.getElementById('issuanceDate').value = data.issuanceDate || '';
                            document.getElementById('remarks1').value = data.remarks || '';
                            
                            // Load sizes data
                            if (data.sizes) {
                                // Parse the sizes string back to object
                                sizeQuantities = {};
                                const sizePairs = data.sizes.split(', ');
                                sizePairs.forEach(pair => {
                                    const [size, qty] = pair.split(' - ');
                                    if (size && qty) {
                                        sizeQuantities[size] = parseInt(qty);
                                    }
                                });
                                updateSizeDisplay('sizeDisplay1');
                            }
                            
                            // Change form to edit mode
                            document.querySelector('#ppeIssuanceForm button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Update PPE Issuance';
                        } else if (type === 'stock') {
                            // Switch to stock form tab
                            switchFormTab('form2', document.querySelector('.form-tab[onclick*="form2"]'));
                            
                            // Fill form with existing data
                            document.getElementById('typesOfPPE2').value = data.typesOfPPE || '';
                            document.getElementById('minQty').value = data.minQty || '';
                            document.getElementById('currentQty').value = data.currentQty || '';
                            
                            // Change form to edit mode
                            document.querySelector('#ppeStockForm button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Update PPE Stock';
                        }
                        
                        // Set editing state
                        editingId = id;
                        editingType = type;
                        
                        // Scroll to form
                        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
                        
                        console.log(`‚úÖ Editing fire PPE ${type}:`, id);
                    }
                })
                .catch((error) => {
                    console.error(`‚ùå Error loading fire PPE ${type} for edit:`, error);
                    alert(`Error loading fire PPE ${type} data: ` + error.message);
                });
        }

        function deleteFirePPE(id, type) {
            if (!confirm(`Are you sure you want to delete this PPE ${type} record?`)) {
                return;
            }

            if (!db) {
                alert("Firebase not initialized. Please refresh the page.");
                return;
            }

            const collectionName = type === 'issuance' ? 'firePPEIssuance' : 'firePPEStock';

            db.collection(collectionName).doc(id).delete()
                .then(() => {
                    console.log(`‚úÖ Fire PPE ${type} deleted successfully`);
                    alert(`Fire PPE ${type} deleted successfully!`);
                    loadFirePPEData();
                })
                .catch((error) => {
                    console.error(`‚ùå Error deleting fire PPE ${type}:`, error);
                    alert(`Error deleting fire PPE ${type}: ` + error.message);
                });
        }

        function clearForm(formId, sizeDisplayId = null) {
            document.getElementById(formId).reset();
            editingId = null;
            editingType = null;
            
            if (sizeDisplayId) {
                sizeQuantities = {};
                updateSizeDisplay(sizeDisplayId);
            }
            
            // Reset button text
            if (formId === 'ppeIssuanceForm') {
                document.querySelector('#ppeIssuanceForm button[type="submit"]').innerHTML = '<i class="fas fa-plus"></i> Add PPE Issuance';
            } else if (formId === 'ppeStockForm') {
                document.querySelector('#ppeStockForm button[type="submit"]').innerHTML = '<i class="fas fa-plus"></i> Add PPE Stock';
                
                // Auto-fill min qty again when form is cleared jika ada jenis PPE yang dipilih
                if (document.getElementById('typesOfPPE2').value) {
                    setTimeout(autoFillPPEMinQty, 300);
                }
            }
        }

        // Search function
        function searchTable(type) {
            const searchTerm = document.getElementById(`search${type.charAt(0).toUpperCase() + type.slice(1)}`).value.toLowerCase();
            const tableBody = document.getElementById(`ppe${type.charAt(0).toUpperCase() + type.slice(1)}TableBody`);
            const rows = tableBody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let found = false;
                
                for (let j = 0; j < cells.length; j++) {
                    if (cells[j].textContent.toLowerCase().includes(searchTerm)) {
                        found = true;
                        break;
                    }
                }
                
                rows[i].style.display = found ? '' : 'none';
            }
        }

        // Sort function
        function sortTable(type, field) {
            const tableBody = document.getElementById(`ppe${type.charAt(0).toUpperCase() + type.slice(1)}TableBody`);
            const rows = Array.from(tableBody.getElementsByTagName('tr'));
            
            // Update sort state
            if (sortState[type].field === field) {
                sortState[type].direction = sortState[type].direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState[type].field = field;
                sortState[type].direction = 'asc';
            }
            
            // Sort rows
            rows.sort((a, b) => {
                const aValue = a.cells[getColumnIndex(type, field)].textContent;
                const bValue = b.cells[getColumnIndex(type, field)].textContent;
                
                // Handle numeric values
                if (field === 'minQty' || field === 'currentQty') {
                    const aNum = parseFloat(aValue) || 0;
                    const bNum = parseFloat(bValue) || 0;
                    return sortState[type].direction === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // Handle date values
                if (field === 'issuanceDate' || field === 'timestamp') {
                    const aDate = new Date(aValue);
                    const bDate = new Date(bValue);
                    return sortState[type].direction === 'asc' ? aDate - bDate : bDate - aDate;
                }
                
                // Handle text values
                return sortState[type].direction === 'asc' 
                    ? aValue.localeCompare(bValue) 
                    : bValue.localeCompare(aValue);
            });
            
            // Update table
            rows.forEach(row => tableBody.appendChild(row));
            
            // Update sort indicators
            updateSortIndicators(type, field);
        }

        function getColumnIndex(type, field) {
            const fieldMap = {
                issuance: {
                    'typesOfPPE': 0,
                    'sizes': 1,
                    'latestIssuance': 2,
                    'issuanceDate': 3,
                    'remarks': 4,
                    'timestamp': 5
                },
                stock: {
                    'typesOfPPE': 0,
                    'minQty': 1,
                    'currentQty': 2,
                    'timestamp': 4
                }
            };
            
            return fieldMap[type][field];
        }

        function updateSortIndicators(type, field) {
            // Reset all sort indicators
            const headers = document.querySelectorAll(`#${type}TableContent th`);
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
                const icon = header.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-sort';
                }
            });
            
            // Set active sort indicator
            const activeHeader = document.querySelector(`#${type}TableContent th:nth-child(${getColumnIndex(type, field) + 1})`);
            if (activeHeader) {
                activeHeader.classList.add(`sort-${sortState[type].direction}`);
                const icon = activeHeader.querySelector('i');
                if (icon) {
                    icon.className = sortState[type].direction === 'asc' 
                        ? 'fas fa-sort-up' 
                        : 'fas fa-sort-down';
                }
            }
        }

        window.refreshData = function() {
            console.log("üîÑ Manually refreshing data...");
            const loadingIssuanceMessage = document.getElementById('loadingIssuanceMessage');
            const noIssuanceDataMessage = document.getElementById('noIssuanceDataMessage');
            const issuanceTableContent = document.getElementById('issuanceTableContent');
            
            const loadingStockMessage = document.getElementById('loadingStockMessage');
            const noStockDataMessage = document.getElementById('noStockDataMessage');
            const stockTableContent = document.getElementById('stockTableContent');
            
            if (loadingIssuanceMessage) loadingIssuanceMessage.style.display = 'block';
            if (noIssuanceDataMessage) noIssuanceDataMessage.style.display = 'none';
            if (issuanceTableContent) issuanceTableContent.style.display = 'none';
            
            if (loadingStockMessage) loadingStockMessage.style.display = 'block';
            if (noStockDataMessage) noStockDataMessage.style.display = 'none';
            if (stockTableContent) stockTableContent.style.display = 'none';
            
            setTimeout(() => {
                loadFirePPEData();
            }, 500);
        };
    </script>
</body>
</html>