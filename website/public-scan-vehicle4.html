<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSV Inspection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="scanner.css">
    <link rel="stylesheet" href="vehiclescan.css">
    <link rel="stylesheet" href="scan2.css">
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Mobile-friendly responsive styles */
        @media (max-width: 768px) {
            .info-popup {
                width: 95% !important;
                margin: 10px !important;
                padding: 15px !important;
            }
            
            .popup-header h1 {
                font-size: 1.5rem !important;
            }
            
            .info-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            .radio-info-grid {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .main-actions {
                flex-direction: column !important;
            }
            
            .main-action-btn {
                width: 100% !important;
                margin-bottom: 10px !important;
            }
            
            .equipment-table {
                font-size: 14px !important;
            }
            
            .equipment-table th,
            .equipment-table td {
                padding: 8px 5px !important;
            }
            
            .vehicle-text-field {
                width: 120px !important;
            }
            
            .category-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 15px !important;
            }
            
            .category-card {
                padding: 15px 5px !important;
            }
            
            .category-icon {
                width: 50px !important;
                height: 50px !important;
            }
            
            .category-icon i {
                font-size: 24px !important;
            }
            
            .equipment-list-container {
                padding: 15px !important;
            }
            
            .equipment-item {
                flex-direction: column !important;
                text-align: center !important;
                padding: 15px 10px !important;
            }
            
            .equipment-details {
                margin-bottom: 10px !important;
            }
            
            .equipment-checkbox-container {
                justify-content: center !important;
            }
        }
        
        @media (max-width: 480px) {
            .info-grid {
                grid-template-columns: 1fr !important;
            }
            
            .category-grid {
                grid-template-columns: 1fr !important;
            }
            
            .equipment-table {
                font-size: 12px !important;
            }
            
            .vehicle-text-field {
                width: 100px !important;
                font-size: 12px !important;
            }
        }
        
        /* EQUIPMENT ITEM STYLES - UPDATED FOR COMPACT VIEW */
        .equipment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px !important; /* Dikecilkan dari 18px 20px */
            margin-bottom: 10px !important; /* Dikecilkan dari 15px */
            background-color: var(--light-bg);
            border-radius: 8px !important; /* Dikecilkan dari 10px */
            border-left: 3px solid var(--primary-color) !important; /* Dikecilkan dari 4px */
            transition: all 0.3s ease;
        }
        
        .equipment-item:hover {
            background-color: rgba(74, 108, 247, 0.05);
            transform: translateX(5px);
        }
        
        .equipment-details {
            flex: 1;
            padding-right: 10px;
        }
        
        .equipment-name {
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 3px !important; /* Dikecilkan dari 5px */
            font-size: 15px !important; /* Dikecilkan dari 16px */
        }
        
        .equipment-description {
            font-size: 13px !important; /* Dikecilkan dari 14px */
            color: var(--light-text);
            margin-bottom: 5px !important; /* Dikecilkan dari 8px */
        }
        
        .equipment-code {
            font-size: 11px !important; /* Dikecilkan dari 12px */
            color: var(--secondary-color);
            background-color: rgba(0, 0, 0, 0.05);
            padding: 2px 6px !important; /* Dikecilkan dari 3px 8px */
            border-radius: 3px !important; /* Dikecilkan dari 4px */
            display: inline-block;
        }
        
        /* Checkbox style untuk equipment inspection */
        .equipment-checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .equipment-checkbox {
            width: 22px !important;
            height: 22px !important;
            border-radius: 5px !important;
            border: 2px solid var(--primary-color) !important;
            background-color: white;
            cursor: pointer;
            appearance: none;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .equipment-checkbox:checked {
            background-color: var(--primary-color);
        }
        
        .equipment-checkbox:checked::after {
            content: 'âœ“';
            position: absolute;
            color: white;
            font-size: 14px;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .checkbox-label {
            font-size: 14px;
            color: var(--dark-text);
            font-weight: 500;
            white-space: nowrap;
        }
        
        /* Category Grid Styles */
        .category-container {
            padding: 20px;
        }
        
        .category-container h3 {
            margin-bottom: 20px;
            color: var(--dark-text);
            text-align: center;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .category-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 25px 15px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-color);
        }
        
        .category-card.active {
            border-color: var(--primary-color);
            background-color: rgba(74, 108, 247, 0.05);
        }
        
        .category-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .category-icon i {
            font-size: 32px;
            color: white;
        }
        
        .category-label {
            font-weight: 600;
            text-align: center;
            color: var(--dark-text);
            font-size: 16px;
        }
        
        .category-desc {
            font-size: 12px;
            color: var(--light-text);
            text-align: center;
            margin-top: 5px;
        }
        
        /* Equipment List Styles */
        .equipment-list-container {
            padding: 25px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        
        .equipment-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .equipment-list-header h3 {
            margin: 0;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .equipment-list-header h3 i {
            color: var(--primary-color);
        }
        
        .save-equipment-btn {
            margin-top: 30px;
            text-align: center;
        }
        
        /* Back button styling */
        .back-to-categories {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: var(--primary-color);
            font-weight: 600;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .back-to-categories:hover {
            background-color: rgba(74, 108, 247, 0.1);
        }
        
        /* RSV Type Indicator */
        .rsv-type-indicator {
            display: inline-block;
            padding: 4px 12px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-complete {
            background-color: #38a169;
            color: white;
        }
        
        .status-incomplete {
            background-color: #e53e3e;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Inspection Details Modal -->
    <div id="inspectionDetailsModal" class="inspection-modal-overlay" style="display: none;">
        <div class="inspection-modal-content">
            <div class="inspection-modal-header">
                <h2><i class="fas fa-clipboard-check"></i> Inspection Details</h2>
                <p id="modalInstructionText">Please fill in inspection details</p>
            </div>
            
            <div class="info-header-container">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">DAY</div>
                        <div class="info-value" id="modalDayDisplay">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">DATE</div>
                        <div class="info-value" id="modalDateDisplay">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">CURRENT SHIFT</div>
                        <div class="info-value" id="modalCurrentShift">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">CURRENT TIME</div>
                        <div class="info-value" id="modalCurrentTime">-</div>
                    </div>
                </div>
            </div>
            
            <!-- Hanya show shift yang aktif berdasarkan masa sekarang -->
            <div class="form-group">
                <label>Inspection Time:</label>
                <div id="timeSelector">
                    <div class="time-option active" id="activeTimeOption">
                        <!-- Akan diisi oleh JavaScript -->
                    </div>
                </div>
                <input type="hidden" id="modalTime" value="">
            </div>
            
            <div class="form-group">
                <label>Inspect By:</label>
                <input type="text" id="modalInspectBy" class="modal-input" placeholder="Enter inspector name">
            </div>
            
            <!-- REMOVED MEDIC FIELD - RSV doesn't need medic -->
            <div class="form-group">
                <label>SWC / WC:</label>
                <input type="text" id="modalSWCWC" class="modal-input" placeholder="Enter SWC/WC name">
            </div>
            
            <div class="form-group">
                <label>Remarks:</label>
                <textarea id="modalRemarks" class="modal-input remarks-textarea" placeholder="Enter optional remarks (if any)"></textarea>
            </div>
            
            <div class="form-group">
                <label>Shift:</label>
                <select id="modalShift" class="modal-input">
                    <option value="">Select Shift</option>
                    <option value="A">Shift A</option>
                    <option value="B">Shift B</option>
                    <option value="C">Shift C</option>
                    <option value="D">Shift D</option>
                </select>
            </div>
            
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeInspectionModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveInspectionDetails()">Continue to Inspect</button>
            </div>
        </div>
    </div>

    <!-- Main popup content -->
    <div class="info-popup">
        <div class="popup-header">
            <h1><i class="fas fa-truck-pickup"></i> RSV Inspection 
                <span id="rsvTypeBadge" class="rsv-type-indicator">Loading...</span>
            </h1>
            <div class="header-buttons">
                <button class="pdf-btn" onclick="saveAsPDF()" id="pdfButton">
                    <i class="fas fa-file-pdf"></i> Save as PDF
                </button>
                <button class="close-btn" onclick="closePopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div class="loading-container" id="loadingMessage">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Loading RSV inspection...</p>
        </div>

        <div class="error-container" id="errorMessage" style="display: none;">
            <i class="fas fa-exclamation-triangle fa-2x"></i>
            <p id="errorText"></p>
            <button class="action-btn" onclick="retryLoading()"><i class="fas fa-redo"></i> Try Again</button>
        </div>

        <div id="vehicleInfoContent" style="display: none;">
            <!-- Info header dengan layout teratur -->
            <div class="info-header-container" id="dailyInfoBanner">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">DAY</div>
                        <div class="info-value" id="currentDayDisplay">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">DATE</div>
                        <div class="info-value" id="currentDateDisplay">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">CURRENT SHIFT</div>
                        <div class="info-value" id="currentShiftDisplay">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">CURRENT TIME</div>
                        <div class="info-value" id="currentTimeDisplay">-</div>
                    </div>
                </div>
            </div>

            <!-- VEHICLE INFO -->
            <div class="radio-info-grid" id="basicInfo">
                <div class="radio-info-item">
                    <div class="radio-info-label">Vehicle Number</div>
                    <div class="radio-info-value" id="vehicleNumber">-</div>
                </div>
                <div class="radio-info-item">
                    <div class="radio-info-label">Vehicle Type</div>
                    <div class="radio-info-value" id="vehicleType">-</div>
                </div>
                <div class="radio-info-item">
                    <div class="radio-info-label">RSV Category</div>
                    <div class="radio-info-value" id="rsvCategory">-</div>
                </div>
            </div>

            <!-- MAIN ACTION BUTTONS - VEHICLE & EQUIPMENT INSPECTION -->
            <div class="main-actions" id="mainActions">
                <button class="main-action-btn inspection" onclick="showVehicleInspectionSection()" id="vehicleInspectionBtn" disabled>
                    <i class="fas fa-clipboard-check"></i> Vehicle Inspection
                </button>
                <button class="main-action-btn equipment" onclick="showEquipmentCategories()" id="equipmentInspectionBtn" disabled>
                    <i class="fas fa-tools"></i> Equipment Inspection
                </button>
            </div>

            <!-- VEHICLE INSPECTION SECTION -->
            <div class="inspection-section" id="vehicleInspectionSection" style="display: none;">
                <button class="section-back-btn" onclick="backToMainActions()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                
                <h3><i class="fas fa-clipboard-check"></i> Vehicle Inspection Checklist 
                    <span id="currentTimeIndicator" class="time-selector-indicator"></span>
                </h3>
                
                <div class="equipment-table-container">
                    <table class="equipment-table">
                        <thead>
                            <tr>
                                <th>INSPECTION ITEM</th>
                                <th>CHECKBOX / TEXTFIELD</th>
                                <th>REMARKS</th>
                            </tr>
                        </thead>
                        <tbody id="vehicleInspectionTableBody">
                            <!-- Vehicle inspection items akan dipopulate oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="save-section" id="vehicleSaveSection" style="display: block; margin-top: 20px;">
                    <button class="save-btn" onclick="saveVehicleInspectionData()"><i class="fas fa-save"></i> SAVE VEHICLE INSPECTION</button>
                </div>
            </div>

            <!-- EQUIPMENT CATEGORIES SECTION -->
            <div class="inspection-section" id="equipmentCategoriesSection" style="display: none;">
                <button class="section-back-btn" onclick="backToMainActions()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                
                <h3><i class="fas fa-tools"></i> Equipment Categories</h3>
                <p style="text-align: center; color: var(--light-text); margin-bottom: 25px;">
                    Select a category to inspect equipment
                </p>
                
                <div class="category-container">
                    <div class="category-grid" id="categoryGrid">
                        <!-- Categories will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- EQUIPMENT LIST SECTION -->
            <div class="inspection-section" id="equipmentListSection" style="display: none;">
                <button class="section-back-btn" onclick="backToEquipmentCategories()">
                    <i class="fas fa-arrow-left"></i> Back to Categories
                </button>
                
                <div class="equipment-list-container">
                    <div class="equipment-list-header">
                        <h3><i class="fas fa-briefcase"></i> <span id="currentCategoryTitle">Equipment List</span></h3>
                        <div class="status-badge" id="equipmentStatusBadge">
                            <!-- Status will be updated dynamically -->
                        </div>
                    </div>
                    
                    <div id="equipmentListContent">
                        <!-- Equipment list will be populated by JavaScript -->
                    </div>
                    
                    <div class="save-equipment-btn">
                        <button class="save-btn" onclick="saveEquipmentInspection()">
                            <i class="fas fa-save"></i> SAVE EQUIPMENT INSPECTION
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // ================ GLOBAL VARIABLES ================ //
        const firebaseConfig = {
            apiKey: "AIzaSyBf9xdF0qmVYaNWFUuEys-P5a1yuTpLdVY",
            authDomain: "project123-82272.firebasestorage.app",
            projectId: "project123-82272",
            storageBucket: "project123-82272.firebasestorage.app",
            messagingSenderId: "97561643123",
            appId: "1:97561643123:web:92596bb20645124f68c206",
            measurementId: "G-D5P85TT95P"
        };

        let db;
        let currentVehicleId = null;
        let currentVehicleData = null;
        let currentDocumentId = null;
        let rsvType = null; // S1, S4, or S5 based on vehicle number
        let currentCategory = null;
        
        // Vehicle inspection data
        let vehicleInspectionData = [];
        
        // Equipment inspection data structure
        let equipmentInspectionData = {
            'BAG ATAS A1': { items: [], completed: false },
            'BAG ATAS A2': { items: [], completed: false },
            'BAG BAWAH A3': { items: [], completed: false },
            'ROPES BAG': { items: [], completed: false },
            'OTHER': { items: [], completed: false }
        };

        // Simpan data untuk kedua-dua shift - REMOVED MEDIC FIELD
        let inspectionDetails0800 = {
            inspectBy: '',
            swcwc: '',      // MEDIC FIELD REMOVED
            shift: '',
            remarks: '',
            time: '0800-2000',
            completed: false,
            timestamp: null,
            vehicleInspectionData: [],
            equipmentInspectionData: equipmentInspectionData
        };
        
        let inspectionDetails2000 = {
            inspectBy: '',
            swcwc: '',      // MEDIC FIELD REMOVED
            shift: '',
            remarks: '',
            time: '2000-0800',
            completed: false,
            timestamp: null,
            vehicleInspectionData: [],
            equipmentInspectionData: equipmentInspectionData
        };
        
        // Determine active shift based on current time
        let currentInspectionTime = '';
        let currentActiveShift = '';
        let currentDate = new Date().toISOString().split('T')[0];

        // VEHICLE INSPECTION ITEMS untuk RSV (sama seperti MPRV)
        const vehicleInspectionItems = [
            { name: "FUEL LEVEL", type: "textfield" },
            { name: "RADIATOR WATER LEVEL", type: "checkbox" },
            { name: "ENGINE OIL", type: "checkbox" },
            { name: "POWER STEERING OIL", type: "checkbox" },
            { name: "BRAKE OIL", type: "checkbox" },
            { name: "WIPER WATER", type: "checkbox" },
            { name: "BATTERY WATER LEVEL", type: "checkbox" },
            { name: "CONDITION / TYRE PRESSURE", type: "checkbox" },
            { name: "WIPER", type: "checkbox" },
            { name: "BEACON LIGHT", type: "checkbox" },
            { name: "MOBILE RADIO SET TEST", type: "checkbox" },
            { name: "ROUTE RUNNING", type: "checkbox" },
            { name: "BRAKE CONDITION", type: "checkbox" },
            { name: "VEHICLE CLEANLINESS", type: "checkbox" },
            { name: "BOMBA CERTIFICATE", type: "checkbox" },
            { name: "MILLAGE / ODOMETER", type: "textfield" }
        ];

        // EQUIPMENT CATEGORIES dan ITEMS untuk RSV (dari gambar yang diberikan)
        const equipmentCategories = [
            { 
                id: 'BAG ATAS A1', 
                name: 'BAG ATAS A1', 
                icon: 'fas fa-briefcase',
                description: 'Upper Bag A1 Equipment',
                items: [
                    { id: 'A1-001', name: 'Carabinars', description: 'Rescue carabiners', defaultQty: 5 },
                    { id: 'A1-002', name: 'Webbing', description: 'Rescue webbing', defaultQty: 3 },
                    { id: 'A1-003', name: 'Brake Barrack', description: 'Brake barrack', defaultQty: 1 },
                    { id: 'A1-004', name: 'Figure of Eight', description: 'Figure 8 descender', defaultQty: 1 },
                    { id: 'A1-005', name: 'Gibbs', description: 'Gibbs ascender', defaultQty: 1 },
                    { id: 'A1-006', name: 'Single Pulley', description: 'Single pulley', defaultQty: 1 },
                    { id: 'A1-007', name: 'Tandem Pulley', description: 'Tandem pulley', defaultQty: 1 },
                    { id: 'A1-008', name: 'Anchor Rope', description: 'Anchor rope', defaultQty: 1 },
                    { id: 'A1-009', name: 'Stopper', description: 'Rope stopper', defaultQty: 2 }
                ]
            },
            { 
                id: 'BAG ATAS A2', 
                name: 'BAG ATAS A2', 
                icon: 'fas fa-briefcase',
                description: 'Upper Bag A2 Equipment',
                items: [
                    { id: 'A2-001', name: 'Carabinars', description: 'Rescue carabiners', defaultQty: 5 },
                    { id: 'A2-002', name: 'Anchor Plate', description: 'Anchor plate', defaultQty: 1 },
                    { id: 'A2-003', name: 'Anchor Strap (Black)', description: 'Black anchor strap', defaultQty: 2 },
                    { id: 'A2-004', name: 'Figure of Eight', description: 'Figure 8 descender', defaultQty: 1 },
                    { id: 'A2-005', name: 'Webbing', description: 'Rescue webbing', defaultQty: 1 },
                    { id: 'A2-006', name: 'Double Pulley', description: 'Double pulley', defaultQty: 1 },
                    { id: 'A2-007', name: 'Tandem Pulley', description: 'Tandem pulley', defaultQty: 1 },
                    { id: 'A2-008', name: 'Anchor Rope', description: 'Anchor rope', defaultQty: 1 },
                    { id: 'A2-009', name: 'Pull Gibbs', description: 'Pull Gibbs', defaultQty: 1 }
                ]
            },
            { 
                id: 'BAG BAWAH A3', 
                name: 'BAG BAWAH A3', 
                icon: 'fas fa-suitcase',
                description: 'Lower Bag A3 Equipment',
                items: [
                    { id: 'A3-001', name: 'Carabinars', description: 'Rescue carabiners', defaultQty: 5 },
                    { id: 'A3-002', name: 'Juma', description: 'Jumar ascender', defaultQty: 2 },
                    { id: 'A3-003', name: 'Anchor / Pick of Strap', description: 'Anchor pick strap', defaultQty: 1 },
                    { id: 'A3-004', name: 'Figure of Eight', description: 'Figure 8 descender', defaultQty: 1 },
                    { id: 'A3-005', name: 'Webbing', description: 'Rescue webbing', defaultQty: 1 },
                    { id: 'A3-006', name: 'Double Pulley', description: 'Double pulley', defaultQty: 1 },
                    { id: 'A3-007', name: 'Gibbs', description: 'Gibbs ascender', defaultQty: 1 },
                    { id: 'A3-008', name: 'Single Pulley', description: 'Single pulley', defaultQty: 3 },
                    { id: 'A3-009', name: 'Pull Gibbs', description: 'Pull Gibbs', defaultQty: 1 }
                ]
            },
            { 
                id: 'ROPES BAG', 
                name: 'ROPES BAG', 
                icon: 'fas fa-rope',
                description: 'Ropes and Lines',
                items: [
                    { id: 'R-001', name: '12mm x 200m (Blue)', description: 'Blue rope 12mm x 200m', defaultQty: 1 },
                    { id: 'R-002', name: '12mm x 200m (Yellow)', description: 'Yellow rope 12mm x 200m', defaultQty: 1 },
                    { id: 'R-003', name: '9mm x 200m (Orange)', description: 'Orange rope 9mm x 200m', defaultQty: 1 },
                    { id: 'R-004', name: '12mm x 50m (Blue)', description: 'Blue rope 12mm x 50m', defaultQty: 1 },
                    { id: 'R-005', name: '12mm x 50m (Red)', description: 'Red rope 12mm x 50m', defaultQty: 1 },
                    { id: 'R-006', name: '12mm x 50m (White)', description: 'White rope 12mm x 50m', defaultQty: 1 },
                    { id: 'R-007', name: '12mm x 5m (Blue)', description: 'Blue rope 12mm x 5m', defaultQty: 1 }
                ]
            },
            { 
                id: 'OTHER', 
                name: 'OTHER', 
                icon: 'fas fa-boxes',
                description: 'Other Miscellaneous Equipment',
                items: [
                    { id: 'O-001', name: 'Rescue Harness', description: 'Rescue harness', defaultQty: 4 },
                    { id: 'O-002', name: 'Glove (Black/Yellow)', description: 'Black/Yellow gloves', defaultQty: 5 },
                    { id: 'O-003', name: 'Paraguard Stretcher', description: 'Paraguard stretcher', defaultQty: 1 },
                    { id: 'O-004', name: 'Rescue Helmet', description: 'Rescue helmet', defaultQty: 9 },
                    { id: 'O-005', name: 'Anchor Plate', description: 'Anchor plate', defaultQty: 1 },
                    { id: 'O-006', name: 'Stopper', description: 'Rope stopper', defaultQty: 2 },
                    { id: 'O-007', name: 'Webbing', description: 'Rescue webbing', defaultQty: 3 },
                    { id: 'O-008', name: 'Ethrier', description: 'Etrier ladder', defaultQty: 1 },
                    { id: 'O-009', name: 'Carabinars', description: 'Rescue carabiners', defaultQty: 6 },
                    { id: 'O-010', name: 'Figure of Eight', description: 'Figure 8 descender', defaultQty: 2 },
                    { id: 'O-011', name: 'Brake Barrack', description: 'Brake barrack', defaultQty: 1 },
                    { id: 'O-012', name: 'Single Pulley', description: 'Single pulley', defaultQty: 1 },
                    { id: 'O-013', name: 'Prusik', description: 'Prusik cord', defaultQty: 1 }
                ]
            }
        ];

        // Initialize Firebase
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            loadVehicleDataFromURL();
        });

        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                console.log("âœ… Firebase initialized for RSV Inspection");
            } catch (error) {
                showError('Failed to initialize database.');
            }
        }

        // ================ SHIFT LOGIC FUNCTIONS ================ //

        function determineCurrentShift() {
            const now = new Date();
            const currentHour = now.getHours();
            
            console.log(`ðŸ• Current time: ${currentHour}:${now.getMinutes()}`);
            
            if (currentHour >= 8 && currentHour < 20) {
                currentActiveShift = '0800-2000';
                currentInspectionTime = '0800-2000';
            } else {
                currentActiveShift = '2000-0800';
                currentInspectionTime = '2000-0800';
            }
            
            console.log(`âœ… Current shift determined: ${currentActiveShift}`);
            return currentActiveShift;
        }

        function getCurrentTimeDisplay() {
            const now = new Date();
            return now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
        }

        function updateCurrentDate() {
            const today = new Date();
            currentDate = today.toISOString().split('T')[0];
            
            const day = today.toLocaleDateString('en-US', { weekday: 'long' });
            const date = today.toLocaleDateString('en-US', { 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            }).toUpperCase();
            
            document.getElementById('currentDayDisplay').textContent = day;
            document.getElementById('currentDateDisplay').textContent = date;
            document.getElementById('modalDayDisplay').textContent = day;
            document.getElementById('modalDateDisplay').textContent = date;
            
            console.log(`ðŸ“… Current date: ${currentDate}`);
        }

        function updateCurrentTimeAndShift() {
            const activeShift = determineCurrentShift();
            const currentTime = getCurrentTimeDisplay();
            
            document.getElementById('currentShiftDisplay').textContent = activeShift;
            document.getElementById('currentTimeDisplay').textContent = currentTime;
            document.getElementById('modalCurrentShift').textContent = activeShift;
            document.getElementById('modalCurrentTime').textContent = currentTime;
            
            const timeOption = document.getElementById('activeTimeOption');
            timeOption.textContent = activeShift;
            timeOption.className = 'time-option active';
            
            document.getElementById('modalTime').value = activeShift;
            
            console.log(`â° Display updated - Shift: ${activeShift}, Time: ${currentTime}`);
        }

        function updateShiftStatusDisplay() {
            const is0800Completed = inspectionDetails0800.completed;
            const is2000Completed = inspectionDetails2000.completed;
            
            if (currentActiveShift === '0800-2000') {
                if (is0800Completed) {
                    document.getElementById('currentShiftDisplay').innerHTML = `0800-2000 âœ“`;
                    document.getElementById('currentShiftDisplay').className = 'info-value status-completed';
                } else {
                    document.getElementById('currentShiftDisplay').textContent = '0800-2000 (Pending)';
                    document.getElementById('currentShiftDisplay').className = 'info-value status-pending';
                }
            } else {
                if (is2000Completed) {
                    document.getElementById('currentShiftDisplay').innerHTML = `2000-0800 âœ“`;
                    document.getElementById('currentShiftDisplay').className = 'info-value status-completed';
                } else {
                    document.getElementById('currentShiftDisplay').textContent = '2000-0800 (Pending)';
                    document.getElementById('currentShiftDisplay').className = 'info-value status-pending';
                }
            }
            
            console.log(`ðŸ“Š Shift status: 0800-2000: ${is0800Completed ? 'Completed' : 'Pending'}, 2000-0800: ${is2000Completed ? 'Completed' : 'Pending'}`);
        }

        // ================ VEHICLE DATA FUNCTIONS ================ //

        function loadVehicleDataFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            let identifier = urlParams.get('vehicle');
            
            if (!identifier) {
                showError('No RSV identifier provided.');
                return;
            }

            identifier = decodeURIComponent(identifier);
            currentVehicleId = identifier;
            console.log(`ðŸ” Loading RSV data for: ${identifier}`);
            fetchVehicleDataById(identifier);
        }

        function fetchVehicleDataById(vehicleNumber) {
            if (!db) {
                showError('Database not initialized.');
                return;
            }

            showLoading(true);

            console.log(`ðŸ” Fetching vehicle data for: ${vehicleNumber}`);

            db.collection('vehicles')
                .where('vehicleNumber', '==', vehicleNumber)
                .get()
                .then((querySnapshot) => {
                    showLoading(false);
                    
                    if (querySnapshot.empty) {
                        showError(`RSV "${vehicleNumber}" not found in database. Please check if vehicle exists.`);
                        return;
                    }

                    const doc = querySnapshot.docs[0];
                    const data = doc.data();
                    
                    console.log("âœ… Vehicle data loaded:", data);
                    console.log("ðŸ“‹ Available fields:", Object.keys(data));
                    
                    // Determine RSV type based on vehicle number
                    determineRsvType(vehicleNumber);
                    
                    currentVehicleData = data;
                    currentDocumentId = doc.id;
                    
                    updateCurrentDate();
                    determineCurrentShift();
                    updateCurrentTimeAndShift();
                    
                    const dailyInspectionKey = `daily_${currentDate}`;
                    const hasDailyData = data[dailyInspectionKey];
                    
                    if (hasDailyData) {
                        const dailyData = data[dailyInspectionKey];
                        console.log("ðŸ“Š Found existing daily data for:", currentDate);
                        
                        if (dailyData.inspection0800) {
                            inspectionDetails0800 = dailyData.inspection0800;
                            if (!inspectionDetails0800.vehicleInspectionData || inspectionDetails0800.vehicleInspectionData.length === 0) {
                                inspectionDetails0800.vehicleInspectionData = initializeVehicleInspectionData();
                            }
                            if (!inspectionDetails0800.equipmentInspectionData) {
                                inspectionDetails0800.equipmentInspectionData = equipmentInspectionData;
                            } else {
                                equipmentInspectionData = inspectionDetails0800.equipmentInspectionData;
                            }
                        }
                        
                        if (dailyData.inspection2000) {
                            inspectionDetails2000 = dailyData.inspection2000;
                            if (!inspectionDetails2000.vehicleInspectionData || inspectionDetails2000.vehicleInspectionData.length === 0) {
                                inspectionDetails2000.vehicleInspectionData = initializeVehicleInspectionData();
                            }
                            if (!inspectionDetails2000.equipmentInspectionData) {
                                inspectionDetails2000.equipmentInspectionData = equipmentInspectionData;
                            }
                        }
                    } else {
                        console.log("ðŸ“ No existing daily data, initializing new");
                        inspectionDetails0800.vehicleInspectionData = initializeVehicleInspectionData();
                        inspectionDetails2000.vehicleInspectionData = initializeVehicleInspectionData();
                        inspectionDetails0800.equipmentInspectionData = equipmentInspectionData;
                        inspectionDetails2000.equipmentInspectionData = JSON.parse(JSON.stringify(equipmentInspectionData));
                    }
                    
                    // Set current data based on active shift
                    if (currentActiveShift === '0800-2000') {
                        vehicleInspectionData = inspectionDetails0800.vehicleInspectionData;
                        equipmentInspectionData = inspectionDetails0800.equipmentInspectionData;
                    } else {
                        vehicleInspectionData = inspectionDetails2000.vehicleInspectionData;
                        equipmentInspectionData = inspectionDetails2000.equipmentInspectionData;
                    }
                    
                    populateVehicleInfo(data);
                    updateShiftStatusDisplay();
                    
                    // Check and show modal for ACTIVE SHIFT only
                    setTimeout(() => {
                        checkAndShowInspectionModal();
                    }, 500);
                    
                })
                .catch((error) => {
                    showLoading(false);
                    showError(`Database error: ${error.message}`);
                    console.error("âŒ Error fetching RSV data:", error);
                });
        }

        function determineRsvType(vehicleNumber) {
            const vNum = vehicleNumber.toUpperCase();
            
            if (vNum === 'TBH3802') {
                rsvType = 'S1';
            } else if (vNum === 'TAV3850') {
                rsvType = 'S5';
            } else if (vNum === 'TBL6512') {
                rsvType = 'S4';
            } else {
                rsvType = 'UNKNOWN';
            }
            
            console.log(`âœ… RSV Type determined: ${rsvType} for vehicle ${vehicleNumber}`);
            document.getElementById('rsvTypeBadge').textContent = rsvType;
            document.getElementById('rsvCategory').textContent = rsvType;
        }

        function initializeVehicleInspectionData() {
            return vehicleInspectionItems.map(item => {
                if (item.type === "textfield") {
                    return {
                        name: item.name,
                        type: "textfield",
                        value: "",
                        checked: false,
                        remarks: ""
                    };
                } else {
                    return {
                        name: item.name,
                        type: "checkbox",
                        checked: false,
                        remarks: ""
                    };
                }
            });
        }

        function populateVehicleInfo(data) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('vehicleInfoContent').style.display = 'block';

            const vehicleNumber = data.vehicleNumber || currentVehicleId || '-';
            const vehicleType = data.vehicleType || '-';
            
            document.getElementById('vehicleNumber').textContent = vehicleNumber;
            document.getElementById('vehicleType').textContent = vehicleType;
            
            console.log(`âœ… Displaying vehicle: ${vehicleNumber}, Type: ${vehicleType}, RSV Category: ${rsvType}`);
        }

        // ================ MODAL FUNCTIONS ================ //

        function checkAndShowInspectionModal() {
            let isActiveShiftCompleted = false;
            
            if (currentActiveShift === '0800-2000') {
                isActiveShiftCompleted = inspectionDetails0800.completed;
            } else {
                isActiveShiftCompleted = inspectionDetails2000.completed;
            }
            
            document.getElementById('inspectionDetailsModal').style.display = 'flex';
            populateModalForm();
            document.getElementById('vehicleInspectionBtn').disabled = true;
            document.getElementById('equipmentInspectionBtn').disabled = true;
            
            console.log(`ðŸ”„ Modal shown for ${currentActiveShift} shift (Completed: ${isActiveShiftCompleted})`);
        }

        function clearModalForm() {
            document.getElementById('modalInspectBy').value = '';
            document.getElementById('modalSWCWC').value = '';
            document.getElementById('modalShift').value = '';
            document.getElementById('modalRemarks').value = '';
        }

        function updateModalInstructionText() {
            const instructionText = document.getElementById('modalInstructionText');
            let isShiftCompleted = false;
            
            if (currentActiveShift === '0800-2000') {
                isShiftCompleted = inspectionDetails0800.completed;
            } else {
                isShiftCompleted = inspectionDetails2000.completed;
            }
            
            if (isShiftCompleted) {
                instructionText.textContent = `Edit inspection details for ${currentActiveShift} shift`;
            } else {
                instructionText.textContent = `Fill in inspection details for ${currentActiveShift} shift`;
            }
        }

        function populateModalForm() {
            if (currentActiveShift === '0800-2000') {
                if (inspectionDetails0800.completed) {
                    document.getElementById('modalInspectBy').value = inspectionDetails0800.inspectBy || '';
                    document.getElementById('modalSWCWC').value = inspectionDetails0800.swcwc || '';
                    document.getElementById('modalShift').value = inspectionDetails0800.shift || '';
                    document.getElementById('modalRemarks').value = inspectionDetails0800.remarks || '';
                } else {
                    clearModalForm();
                }
            } else {
                if (inspectionDetails2000.completed) {
                    document.getElementById('modalInspectBy').value = inspectionDetails2000.inspectBy || '';
                    document.getElementById('modalSWCWC').value = inspectionDetails2000.swcwc || '';
                    document.getElementById('modalShift').value = inspectionDetails2000.shift || '';
                    document.getElementById('modalRemarks').value = inspectionDetails2000.remarks || '';
                } else {
                    clearModalForm();
                }
            }
            
            updateModalInstructionText();
        }

        function closeInspectionModal() {
            document.getElementById('inspectionDetailsModal').style.display = 'none';
        }

        function saveInspectionDetails() {
            const inspectBy = document.getElementById('modalInspectBy').value.trim();
            const swcwc = document.getElementById('modalSWCWC').value.trim();
            const shift = document.getElementById('modalShift').value;
            const remarks = document.getElementById('modalRemarks').value.trim();
            const time = document.getElementById('modalTime').value;
            
            if (!inspectBy || !swcwc || !shift || !time) {
                alert('Please fill in all required fields');
                return;
            }
            
            const now = new Date().toISOString();
            
            if (time === '0800-2000') {
                inspectionDetails0800 = {
                    ...inspectionDetails0800,
                    inspectBy: inspectBy,
                    swcwc: swcwc,
                    shift: shift,
                    remarks: remarks,
                    time: time,
                    completed: true,
                    timestamp: now
                };
                vehicleInspectionData = inspectionDetails0800.vehicleInspectionData;
                equipmentInspectionData = inspectionDetails0800.equipmentInspectionData;
            } else {
                inspectionDetails2000 = {
                    ...inspectionDetails2000,
                    inspectBy: inspectBy,
                    swcwc: swcwc,
                    shift: shift,
                    remarks: remarks,
                    time: time,
                    completed: true,
                    timestamp: now
                };
                vehicleInspectionData = inspectionDetails2000.vehicleInspectionData;
                equipmentInspectionData = inspectionDetails2000.equipmentInspectionData;
            }
            
            currentInspectionTime = time;
            
            document.getElementById('inspectionDetailsModal').style.display = 'none';
            
            document.getElementById('vehicleInspectionBtn').disabled = false;
            document.getElementById('equipmentInspectionBtn').disabled = false;
            
            updateShiftStatusDisplay();
            updateTimeIndicator();
            
            saveDailyInspectionToDB();
            
            console.log(`ðŸ’¾ Inspection details saved for ${time} shift`);
        }

        // ================ NAVIGATION FUNCTIONS ================ //

        function showVehicleInspectionSection() {
            if (!currentInspectionTime) {
                alert('Please complete inspection details first');
                document.getElementById('inspectionDetailsModal').style.display = 'flex';
                return;
            }
            
            const isCompleted = currentInspectionTime === '0800-2000' ? 
                inspectionDetails0800.completed : inspectionDetails2000.completed;
            
            if (!isCompleted) {
                alert('Please save inspection details first');
                document.getElementById('inspectionDetailsModal').style.display = 'flex';
                return;
            }
            
            document.getElementById('basicInfo').style.display = 'none';
            document.getElementById('mainActions').style.display = 'none';
            document.getElementById('vehicleInspectionSection').style.display = 'block';
            document.getElementById('equipmentCategoriesSection').style.display = 'none';
            document.getElementById('equipmentListSection').style.display = 'none';
            
            populateVehicleInspectionTable();
        }

        function showEquipmentCategories() {
            if (!currentInspectionTime) {
                alert('Please complete inspection details first');
                document.getElementById('inspectionDetailsModal').style.display = 'flex';
                return;
            }
            
            const isCompleted = currentInspectionTime === '0800-2000' ? 
                inspectionDetails0800.completed : inspectionDetails2000.completed;
            
            if (!isCompleted) {
                alert('Please save inspection details first');
                document.getElementById('inspectionDetailsModal').style.display = 'flex';
                return;
            }
            
            document.getElementById('basicInfo').style.display = 'none';
            document.getElementById('mainActions').style.display = 'none';
            document.getElementById('vehicleInspectionSection').style.display = 'none';
            document.getElementById('equipmentCategoriesSection').style.display = 'block';
            document.getElementById('equipmentListSection').style.display = 'none';
            
            populateEquipmentCategories();
        }

        function backToMainActions() {
            document.getElementById('basicInfo').style.display = 'flex';
            document.getElementById('mainActions').style.display = 'flex';
            document.getElementById('vehicleInspectionSection').style.display = 'none';
            document.getElementById('equipmentCategoriesSection').style.display = 'none';
            document.getElementById('equipmentListSection').style.display = 'none';
        }

        function backToEquipmentCategories() {
            document.getElementById('equipmentCategoriesSection').style.display = 'block';
            document.getElementById('equipmentListSection').style.display = 'none';
        }

        // ================ VEHICLE INSPECTION FUNCTIONS ================ //

        function populateVehicleInspectionTable() {
            const tableBody = document.getElementById('vehicleInspectionTableBody');
            
            let currentData = vehicleInspectionData;
            
            let html = '';
            
            currentData.forEach((item, index) => {
                const isTextField = item.type === "textfield";
                const isFuelLevel = item.name === "FUEL LEVEL";
                const isMillage = item.name === "MILLAGE / ODOMETER";
                
                html += `
                    <tr class="${isTextField ? 'textfield-item' : ''}">
                        <td><strong>${item.name}</strong></td>
                        <td style="text-align: center;">
                `;
                
                if (isTextField) {
                    html += `
                            <input type="text" 
                                   class="vehicle-text-field"
                                   id="vehicle-field-${index}"
                                   data-index="${index}"
                                   value="${item.value || ''}"
                                   placeholder="${isFuelLevel ? 'e.g., 75%, FULL' : 'e.g., 12345 km'}"
                                   onchange="updateVehicleTextField(${index}, this.value)"
                                   style="width: 150px;">
                    `;
                } else {
                    html += `
                            <input type="checkbox" 
                                   class="inspection-checkbox"
                                   id="vehicle-checkbox-${index}"
                                   data-index="${index}"
                                   ${item.checked ? 'checked' : ''}
                                   onchange="updateVehicleCheckbox(${index}, this.checked)">
                    `;
                }
                
                html += `
                        </td>
                        <td>
                            <textarea 
                                class="remarks-input"
                                id="vehicle-remarks-${index}"
                                data-index="${index}"
                                onchange="updateVehicleRemarks(${index}, this.value)"
                                placeholder="Enter remarks..."
                                rows="1">${item.remarks || ''}</textarea>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        function updateVehicleCheckbox(index, isChecked) {
            if (!currentInspectionTime) {
                alert('Please select inspection time first');
                return;
            }
            
            let currentData = vehicleInspectionData;
            
            if (currentData[index]) {
                currentData[index].checked = isChecked;
            }
        }

        function updateVehicleTextField(index, value) {
            if (!currentInspectionTime) {
                alert('Please select inspection time first');
                return;
            }
            
            let currentData = vehicleInspectionData;
            
            if (currentData[index]) {
                currentData[index].value = value;
            }
        }

        function updateVehicleRemarks(index, value) {
            if (!currentInspectionTime) {
                alert('Please select inspection time first');
                return;
            }
            
            let currentData = vehicleInspectionData;
            
            if (currentData[index]) {
                currentData[index].remarks = value;
            }
        }

        function saveVehicleInspectionData() {
            saveDailyInspectionToDB();
            alert('Vehicle inspection data saved successfully!');
            backToMainActions();
        }

        // ================ EQUIPMENT INSPECTION FUNCTIONS ================ //

        function populateEquipmentCategories() {
            const categoryGrid = document.getElementById('categoryGrid');
            let html = '';
            
            equipmentCategories.forEach(category => {
                const categoryData = equipmentInspectionData[category.id];
                const isCompleted = categoryData ? categoryData.completed : false;
                const completedCount = categoryData && categoryData.items ? 
                    categoryData.items.filter(item => item.inspected).length : 0;
                const totalCount = category.items.length;
                
                html += `
                    <div class="category-card ${isCompleted ? 'active' : ''}" onclick="showEquipmentList('${category.id}')">
                        <div class="category-icon">
                            <i class="${category.icon}"></i>
                        </div>
                        <span class="category-label">${category.name}</span>
                        <span class="category-desc">${category.description}</span>
                        <div style="margin-top: 10px; font-size: 12px; color: ${isCompleted ? '#38a169' : '#e53e3e'};">
                            ${completedCount}/${totalCount} items
                        </div>
                    </div>
                `;
            });
            
            categoryGrid.innerHTML = html;
        }

        function showEquipmentList(categoryId) {
            currentCategory = categoryId;
            const category = equipmentCategories.find(c => c.id === categoryId);
            
            if (!category) {
                alert('Category not found');
                return;
            }
            
            document.getElementById('equipmentCategoriesSection').style.display = 'none';
            document.getElementById('equipmentListSection').style.display = 'block';
            
            document.getElementById('currentCategoryTitle').textContent = category.name;
            
            // Update status badge
            const categoryData = equipmentInspectionData[categoryId];
            const isCompleted = categoryData ? categoryData.completed : false;
            const statusBadge = document.getElementById('equipmentStatusBadge');
            statusBadge.textContent = isCompleted ? 'COMPLETED' : 'INCOMPLETE';
            statusBadge.className = `status-badge ${isCompleted ? 'status-complete' : 'status-incomplete'}`;
            
            populateEquipmentList(category);
        }

        function populateEquipmentList(category) {
            const equipmentListContent = document.getElementById('equipmentListContent');
            const categoryData = equipmentInspectionData[category.id];
            
            let html = '';
            
            category.items.forEach((item, index) => {
                const storedItem = categoryData && categoryData.items ? 
                    categoryData.items.find(i => i.id === item.id) : null;
                const isInspected = storedItem ? storedItem.inspected : false;
                
                html += `
                    <div class="equipment-item ${isInspected ? 'inspected' : ''}" id="equipment-${item.id}">
                        <div class="equipment-details">
                            <div class="equipment-name">${item.name}</div>
                            <div class="equipment-description">${item.description} <strong>(${item.defaultQty})</strong></div>
                            <span class="equipment-code">${item.id}</span>
                        </div>
                        <div class="equipment-checkbox-container">
                            <input type="checkbox" 
                                   class="equipment-checkbox"
                                   id="checkbox-${item.id}"
                                   ${isInspected ? 'checked' : ''}
                                   onchange="updateEquipmentCheckbox('${item.id}', this.checked, ${item.defaultQty})">
                        </div>
                    </div>
                `;
            });
            
            equipmentListContent.innerHTML = html;
        }

        function updateEquipmentCheckbox(itemId, isChecked, defaultQty) {
            // Update equipment inspection data
            if (!equipmentInspectionData[currentCategory]) {
                equipmentInspectionData[currentCategory] = { items: [], completed: false };
            }
            
            // Find or create the item
            let itemIndex = equipmentInspectionData[currentCategory].items.findIndex(i => i.id === itemId);
            
            if (itemIndex === -1) {
                // Add new item
                equipmentInspectionData[currentCategory].items.push({
                    id: itemId,
                    inspected: isChecked,
                    inspectedQty: isChecked ? defaultQty : 0,
                    timestamp: new Date().toISOString()
                });
            } else {
                // Update existing item
                equipmentInspectionData[currentCategory].items[itemIndex].inspected = isChecked;
                equipmentInspectionData[currentCategory].items[itemIndex].inspectedQty = isChecked ? defaultQty : 0;
                equipmentInspectionData[currentCategory].items[itemIndex].timestamp = new Date().toISOString();
            }
            
            console.log(`ðŸ“ Updated equipment ${itemId} inspection status: ${isChecked} in category ${currentCategory}`);
        }

        function saveEquipmentInspection() {
            // Check if all items have been inspected
            const category = equipmentCategories.find(c => c.id === currentCategory);
            if (!category) {
                alert('Category not found');
                return;
            }
            
            // Mark category as completed
            equipmentInspectionData[currentCategory].completed = true;
            equipmentInspectionData[currentCategory].completionTime = new Date().toISOString();
            
            // Update active shift data
            if (currentInspectionTime === '0800-2000') {
                inspectionDetails0800.equipmentInspectionData = equipmentInspectionData;
            } else {
                inspectionDetails2000.equipmentInspectionData = equipmentInspectionData;
            }
            
            saveDailyInspectionToDB();
            
            alert(`Equipment inspection for ${currentCategory} saved successfully!`);
            
            // Return to categories
            backToEquipmentCategories();
            populateEquipmentCategories();
        }

        // ================ DATABASE FUNCTIONS ================ //

        function saveDailyInspectionToDB() {
            if (!db || !currentDocumentId) {
                console.warn('Database not ready for auto-save');
                return;
            }
            
            const dailyInspectionKey = `daily_${currentDate}`;
            
            const dailyData = {
                [dailyInspectionKey]: {
                    date: currentDate,
                    vehicleNumber: currentVehicleId,
                    rsvType: rsvType,
                    inspection0800: inspectionDetails0800,
                    inspection2000: inspectionDetails2000,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }
            };
            
            db.collection('vehicles')
                .doc(currentDocumentId)
                .update(dailyData)
                .then(() => {
                    console.log(`âœ… Daily inspection details saved for ${currentDate}`);
                })
                .catch((error) => {
                    console.error('Error saving daily inspection:', error);
                });
        }

        function updateTimeIndicator() {
            const timeIndicator = document.getElementById('currentTimeIndicator');
            
            if (currentInspectionTime === '0800-2000') {
                timeIndicator.textContent = '0800-2000';
            } else if (currentInspectionTime === '2000-0800') {
                timeIndicator.textContent = '2000-0800';
            } else {
                timeIndicator.textContent = currentActiveShift;
            }
        }

        // ================ PDF FUNCTION ================ //

        function saveAsPDF() {
            if (!window.jspdf) {
                alert('PDF library not loaded. Please check internet connection.');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Set margins
                const marginLeft = 10;
                const marginRight = 10;
                const pageWidth = doc.internal.pageSize.width;
                
                // ========== HEADER SECTION ==========
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                doc.text("CENTRAL EMERGENCY & FIRE SERVICES RESPONSE", pageWidth/2, 15, { align: "center" });
                
                doc.setFontSize(14);
                doc.text("RAPID SUPPORT VEHICLE (RSV) INSPECTION", pageWidth/2, 22, { align: "center" });
                
                // ========== VEHICLE INFORMATION ==========
                let yPos = 35;
                
                // Line 1: RSV TYPE
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text("RSV TYPE : ", marginLeft, yPos);
                doc.setFont("helvetica", "normal");
                doc.text(rsvType, marginLeft + 35, yPos);
                
                // Line 2: DATE and VEHICLE NUMBER
                yPos += 7;
                
                const now = new Date();
                const monthYear = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }).toUpperCase();
                
                doc.setFont("helvetica", "bold");
                doc.text("DATE:", marginLeft, yPos);
                doc.setFont("helvetica", "normal");
                doc.text(monthYear, marginLeft + 15, yPos);
                
                doc.setFont("helvetica", "bold");
                doc.text("VEHICLE NUMBER", marginLeft + 60, yPos);
                doc.setFont("helvetica", "normal");
                const vehicleNumber = document.getElementById('vehicleNumber')?.textContent || 'N/A';
                doc.text(vehicleNumber, marginLeft + 90, yPos);
                
                // Line 3: TIME, NAME, SHIFT
                yPos += 7;
                
                doc.setFont("helvetica", "bold");
                doc.text("TIME:", marginLeft, yPos);
                doc.setFont("helvetica", "normal");
                doc.text("0800 - 2000", marginLeft + 15, yPos);
                
                doc.setFont("helvetica", "bold");
                doc.text("NAME:", marginLeft + 45, yPos);
                doc.setFont("helvetica", "normal");
                const inspectName = inspectionDetails0800?.inspectBy || inspectionDetails2000?.inspectBy || "N/A";
                doc.text(inspectName, marginLeft + 60, yPos);
                
                doc.setFont("helvetica", "bold");
                doc.text("SHIFT:", marginLeft + 90, yPos);
                doc.setFont("helvetica", "normal");
                const shiftValue = inspectionDetails0800?.shift || inspectionDetails2000?.shift || "N/A";
                doc.text(shiftValue, marginLeft + 105, yPos);
                
                yPos += 15;
                
                // ========== VEHICLE INSPECTION TABLE ==========
                doc.setFontSize(11);
                doc.setFont("helvetica", "bold");
                doc.text("VEHICLE INSPECTION CHECKLIST", marginLeft, yPos);
                yPos += 5;
                
                // Vehicle Inspection Items
                const vehicleData0800 = inspectionDetails0800.vehicleInspectionData;
                const vehicleData2000 = inspectionDetails2000.vehicleInspectionData;
                
                vehicleInspectionItems.forEach((item, index) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(10);
                    doc.text(`${index + 1}. ${item.name}`, marginLeft, yPos);
                    
                    // 0800-2000 value
                    const data0800 = vehicleData0800[index];
                    let value0800 = "BROKEN";
                    
                    if (data0800) {
                        if (item.type === "textfield") {
                            if (item.name === "FUEL LEVEL") {
                                value0800 = data0800.value ? `${data0800.value}%` : "BROKEN";
                            } else if (item.name === "MILLAGE / ODOMETER") {
                                value0800 = data0800.value ? data0800.value : "BROKEN";
                            }
                        } else {
                            value0800 = data0800.checked ? "OK" : "BROKEN";
                        }
                    }
                    doc.text(value0800, marginLeft + 100, yPos);
                    
                    // 2000-0800 value
                    const data2000 = vehicleData2000[index];
                    let value2000 = "BROKEN";
                    
                    if (data2000) {
                        if (item.type === "textfield") {
                            if (item.name === "FUEL LEVEL") {
                                value2000 = data2000.value ? `${data2000.value}%` : "BROKEN";
                            } else if (item.name === "MILLAGE / ODOMETER") {
                                value2000 = data2000.value ? data2000.value : "BROKEN";
                            }
                        } else {
                            value2000 = data2000.checked ? "OK" : "BROKEN";
                        }
                    }
                    doc.text(value2000, marginLeft + 130, yPos);
                    
                    yPos += 5;
                });
                
                // ========== EQUIPMENT INSPECTION SECTION ==========
                yPos += 10;
                
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(11);
                doc.setFont("helvetica", "bold");
                doc.text("EQUIPMENT INSPECTION SUMMARY", marginLeft, yPos);
                yPos += 8;
                
                // Equipment Categories
                equipmentCategories.forEach((category, catIndex) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(10);
                    doc.text(`${catIndex + 1}. ${category.name}`, marginLeft, yPos);
                    yPos += 5;
                    
                    const categoryData = inspectionDetails0800.equipmentInspectionData[category.id] || 
                                       inspectionDetails2000.equipmentInspectionData[category.id];
                    
                    if (categoryData && categoryData.items) {
                        category.items.forEach((item, itemIndex) => {
                            if (yPos > 270) {
                                doc.addPage();
                                yPos = 20;
                            }
                            
                            const storedItem = categoryData.items.find(i => i.id === item.id);
                            const inspectedQty = storedItem ? storedItem.inspectedQty : 0;
                            const status = storedItem && storedItem.inspected ? "âœ“" : "âœ—";
                            
                            doc.setFont("helvetica", "normal");
                            doc.setFontSize(9);
                            doc.text(`   ${itemIndex + 1}. ${item.name}`, marginLeft + 5, yPos);
                            doc.text(`${inspectedQty}/${item.defaultQty}`, marginLeft + 100, yPos);
                            doc.text(status, marginLeft + 130, yPos);
                            
                            yPos += 4;
                        });
                    }
                    
                    yPos += 5;
                });
                
                // ========== SAVE PDF ==========
                const fileName = `RSV_${rsvType}_Inspection_${vehicleNumber}_${monthYear.replace(' ', '_')}.pdf`;
                doc.save(fileName);
                
                console.log('âœ… PDF generated successfully');
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF: ' + error.message);
            }
        }

        // ================ UTILITY FUNCTIONS ================ //

        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
            document.getElementById('errorMessage').style.display = 'none';
            if (!show) document.getElementById('vehicleInfoContent').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = message;
            document.getElementById('vehicleInfoContent').style.display = 'none';
        }

        function retryLoading() {
            const urlParams = new URLSearchParams(window.location.search);
            let vehicleId = urlParams.get('vehicle');
            
            if (vehicleId) {
                vehicleId = decodeURIComponent(vehicleId);
                fetchVehicleDataById(vehicleId);
            }
        }

        function closePopup() {
            if (confirm('Close inspection window?')) {
                window.location.href = 'public-inspection.html';
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closePopup();
        });
    </script>
</body>
</html>